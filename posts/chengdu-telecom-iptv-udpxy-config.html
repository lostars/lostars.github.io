<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>华硕路由器实现iptv组播转单播和单线复用 - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>华硕路由器实现iptv组播转单播和单线复用</h1><div><time>2025-01-26</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/mess/">mess</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/iptv/">iptv</a> </span><span class="tag"><span class="category-separator">#</span> <a href="/tags/router/">router</a></span></div></div></header><p>想要组播转单播通过外网播放iptv和路由器下设备wifi看iptv，同时保证iptv盒子的正常使用。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="运营商"><a href="#运营商" class="headerlink" title="运营商"></a>运营商</h3><p>不同地区的运营商的iptv鉴权方式不一样，我这里是成都电信，采用的是dhcp方式验证，可以参考 <a target="_blank" rel="noopener" href="https://blog.tangwudi.com/technology/ikuai1288/">这里</a> 了解鉴权相关东西。</p><p>这篇文章都是基于<strong>成都电信</strong>，光猫型号：<strong>HS8145V</strong>，且已经修改光猫为桥接。<br>其他地区和运营商可以网上查找下有人分享过iptv相关的东西没。<br>如果没有那就比较麻烦了，需要自己去抓包验证。</p><h3 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h3><p><strong>GT-AC5300</strong></p><p>理论上大部分华硕的路由器都支持iptv功能，中高端路由器都有双拨功能，这就满足了单线复用和组播转单播功能，不需要额外的设备。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>光猫里vlan 43用于iptv，1173用于pppoe拨号上网，用于iptv的43是无法修改的，且绑定了itv口，所以没法通过绑定端口来实现多口itv了，只能通过vlan绑定的方式。</p><p>vlan绑定需要获取光猫超级管理员密码，可以参考 <a target="_blank" rel="noopener" href="https://www.right.com.cn/forum/thread-4089985-1-1.html">这里</a> 进行获取。<br>光猫登陆时候只要有超级密码不用看用户名，登陆进去就是超管。</p><h2 id="单线复用"><a href="#单线复用" class="headerlink" title="单线复用"></a>单线复用</h2><h3 id="VLAN-绑定"><a href="#VLAN-绑定" class="headerlink" title="VLAN 绑定"></a>VLAN 绑定</h3><p>用超管进入光猫管理页面：<code>网络 - VLAN绑定</code> 。路由器的第一wan口接入的是光猫千兆口1上网，按照如下进行绑定：</p><table><thead><tr><th>用户侧端口</th><th>用户侧VLAN</th><th>WAN侧VLAN</th></tr></thead><tbody><tr><td>千兆口1</td><td>43</td><td>43</td></tr><tr><td>千兆口1</td><td>1173</td><td>1173</td></tr><tr><td>其实就是将VLAN 43和VLAN 1173都绑定到千兆口1上。</td><td></td><td></td></tr></tbody></table><h3 id="路由器iptv设置"><a href="#路由器iptv设置" class="headerlink" title="路由器iptv设置"></a>路由器iptv设置</h3><p>进入设置 <code>内部网络 - iptv</code> 将iptv配置到路由器 lan5&#x2F;lan6 lan1和lan2需要配置第二wan。</p><p>选择ISP设置档，手动配置。</p><p>互联网VLAN设置为1173，优先级（PRIO）和光猫上的优先级（802.1p）一致都是 0；<br>LAN 5 VLAN设置为43，优先级（PRIO）也和光猫保持一致：3；<br><strong>这里的设置保存之后路由器会重启。</strong></p><p>这样lan5口就可以直接插上iptv盒子了，同时光猫的itv口也空出来给下面的组播转单播配置。</p><h2 id="组播转单播"><a href="#组播转单播" class="headerlink" title="组播转单播"></a>组播转单播</h2><p>很多华硕路由器其实是支持udpxy的，就在iptv配置页面的下方，但是我们不在这里配置，因为这里的udpxy不和上面的iptv功能兼容。同时udpxy配置也是只能设置端口，默认绑定eth0网口，但是我们的第二wan口lan1对应的接口是eth2。</p><h3 id="配置第二wan口"><a href="#配置第二wan口" class="headerlink" title="配置第二wan口"></a>配置第二wan口</h3><p>路由器主wan口保持原有的pppoe拨号上网不变动，开启双线路：<code>外部网络 - 双线路 - 开启</code> 。<br>首选是wan保持不变，第二wan选择lan1口，双线路模式选择负载均衡，然后开启路由规则，将路由器子网ip流量全部转到第一wan口，毕竟第二wan口是没法联网的。</p><p>连接路由器lan1口与光猫itv口，进入外部网络，配置第二wan口，选择动态ip。</p><p>在这个 <a target="_blank" rel="noopener" href="https://blog.tangwudi.com/technology/ikuai1288/">分享</a> 里提到，需要配置dhcp的option60和61用于鉴权，成都电信60的值是固定 <code>SCITV</code>，61是iptv盒子的mac地址。其他配置保持默认即可。</p><p>我这里实测，两个都填上其实还是不能获取到正确的iptv内网ip（10开头），需要在上面配置页面最下面设置mac地址，不要点击获取计算机mac地址，那个获取的是路由器的，这里手动填写电视盒子的mac地址（盒子背面可以看到）。</p><p>所以最终要的是伪装设备的mac地址进行鉴权。</p><p>保存之后ssh进入路由器就可以看到eth2口的地址已经获取到了，<code>10.x.x.x</code> 的内网地址，获取失败则是光猫的内网地址，<code>192.169.1.x</code>。</p><p><strong>但是这样会出现iptv盒子间歇性的卡初始化进度条，很奇怪（后面会说明为啥）。</strong></p><blockquote><p>华硕路由器那个物理lan口和内部网络接口的对应关系我是真没看明白，lan1对应的是eth2，wan和lan1-lan8，eth0-eth8。</p></blockquote><h3 id="udpxy"><a href="#udpxy" class="headerlink" title="udpxy"></a>udpxy</h3><p>华硕路由器的udpxy执行程序位于 <code>/usr/sbin/udpxy</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">/usr/sbin/udpxy -m eth2 -<span class="hljs-selector-tag">p</span> <span class="hljs-number">8686</span> -<span class="hljs-selector-tag">B</span> <span class="hljs-number">65536</span> -c <span class="hljs-number">8</span> -<span class="hljs-selector-tag">a</span> br0<br></code></pre></td></tr></table></figure><ul><li>-m 监听的接口，这里配置为eth2，如果是路由器页面配置则默认监听eth0；</li><li>-p 监听端口，设置一个未使用的即可；</li><li>-B 每个客户端缓冲区大小 65536 字节；</li><li>-c 最大客户端并发 8</li><li>-a 组播数据转发到br0，这个br0就是路由器内部网络，华硕路由器默认是192.168.50.x；</li></ul><p>运行之后就可以访问 <code>http://192.168.50.1:8686/status</code> 看到udpxy状态了，注意 <code>Multicast addres</code> 是第二wan获取到10开头的内网ip。</p><p>路由器固件是华硕官改，这款不支持梅林，创建udpxy开机启动脚本 <code>/jffs/scripts/init-start</code> ，加入上面的启动命令。</p><p>后面测试过程中发现udpxy进程反复被杀掉，且开机启动脚本也没执行，排查半天没找到原因，最后还是路由器双清重置搞定。</p><h2 id="组播地址和节目单"><a href="#组播地址和节目单" class="headerlink" title="组播地址和节目单"></a>组播地址和节目单</h2><p>组播地址可以自己抓包，如果网上有人分享就更简单了，成都电信 <a target="_blank" rel="noopener" href="http://epg.51zmt.top:8000/sctvmulticast.html">这里</a> 有人进行分享，所以直接用就行。<br>比如CCTV1的组播地址是 <code>239.93.0.58:5140</code> ，那么播放地址就是 <code>http://192.168.50.1:8686/rtp/239.93.0.58:5140</code> ，这个地址可以用各种播放器直接进行播放。再起个代理转发路由器udpxy服务，外网也能看。</p><p>这个站点站长也提供了台标匹配和节目单，直接写个脚本生成m3u播放列表：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">获取节目列表</span><br>curl &quot;http://epg.51zmt.top:8000/e.xml&quot; -o tv.xml<br><span class="hljs-meta prompt_"># </span><span class="language-bash">获取组播源</span><br>curl &quot;http://epg.51zmt.top:8000/sctvmulticast.html&quot; -o playlist-source.html<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">解析html并输出简单的播放列表</span><br>awk &#x27;/&lt;tr class=&quot;odd&quot;&gt;/ || /&lt;tr class=&quot;even&quot;&gt;/ &#123;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">	while($</span><span class="language-bash">0 !~ /&lt;\/tr&gt;/) &#123;</span><br>        if($0 ~ /&lt;td[^&gt;]*&gt;(.*)&lt;\/td&gt;/)&#123;<br>            count++<br>            if(count == 2 || count ==3) &#123;<br>	            match($1, /&gt;(.*)&lt;/, a);<br>	            td[count] = a[1]<br>            &#125;<br>        &#125;<br>        getline<br>    &#125;<br>	printf &quot;#EXTINF:-1 tvg-name=\&quot;%s\&quot;,%s\nhttp://192.168.50.1:8686/rtp/%s\n&quot;, td[2], td[2], td[3]<br>    count=0<br>    <br>&#125;&#x27; playlist-source.html \<br><br>| sed &#x27;1i #EXTM3U&#x27; &gt; playlist-origin.m3u<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">上传播放列表匹配台标</span><br>curl -X POST -F &quot;myfile=@playlist-origin.m3u;type=&#x27;multipart/form-data&#x27;&quot; \<br>&quot;http://epg.51zmt.top:8000/api/upload/&quot; -o upload-result.html<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">解析匹配好台标之后的文件下载地址</span><br>download_path=$(awk -F &#x27;href=&quot;&#x27; &#x27;&#123;print $2&#125;&#x27; upload-result.html | awk -F &#x27;&quot;&#x27; &#x27;&#123;print $1&#125;&#x27;)<br><br>if [[ -n &quot;$download_path&quot; ]]; then<br>	curl &quot;$download_path&quot; -o playlist.m3u<br>	echo &quot;更新iptv成功！&quot;<br>else<br>	echo &quot;未从上传结果中获取到下载地址！&quot;<br>fi<br></code></pre></td></tr></table></figure><h2 id="Emby配置"><a href="#Emby配置" class="headerlink" title="Emby配置"></a>Emby配置</h2><p>emby配置就很简单了，在 <code>设置 - 电视直播</code> 里进行配置，电视源就是m3u播放列表文件，指南数据源就是上面的 <code>tv.xml</code> 节目单。</p><p>注意如果是emby网页端播放直播，一定要开启位于每个用户设置里的转码，不然浏览器没法兼容有些直播流，用客户端就没有这些问题。</p><p>这样，电视盒子和组播都能正常使用，路由器下wifi用户也能使用各种播放器打开上面的m3u播放列表。</p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>经过反复的测试和折腾，发现：</p><p><strong>成都电信只要把光猫上的接入设备修改和盒子拨号之后获取到的同一个IP段就能正常用udpxy转单播看直播了，盒子的鉴权方式只用于获取iptv内部ip，但看直播本身是没有任何鉴权的。</strong></p><h3 id="最终解法"><a href="#最终解法" class="headerlink" title="最终解法"></a>最终解法</h3><ul><li>不用路由器的iptv功能，iptv盒子还是接入光猫itv口。</li><li>路由器开启第二wan口，接入光猫其他空余lan口，配置第二wan口的ip，和盒子获取到的ip在同一个子网就行，千万别重复了。</li><li>第二wan口配置mac伪装。</li><li>配置好udpxy。</li></ul><p>上面配置主要是省了一个udpxy的设备，如果路由器不支持双wan或者udpxy那么就需要额外一个设备。</p><p><em><strong>总结：纯瞎折腾</strong></em></p><h2 id="年后更新"><a href="#年后更新" class="headerlink" title="年后更新"></a>年后更新</h2><p>家里换了千兆（家里都是千兆网口的设备，跑不满，嗅到了折腾的味道），同时也解决了光信号弱的问题，接到电线杆子的光纤信号灯直接红了，难怪。</p><p>和上门小哥聊了挺久，获取到不少信息：</p><ul><li>iptv盒子获取到的ip和mac是绑定的，这也是上面为什么iptv盒子卡认证进度的原因，IP冲突了。</li><li>可以给超级密码，不过拿到用处不大了，已经改了桥接。</li><li>新装宽带没有公网IP了，建议保留这老宽带。</li><li>电信不支持加钱加上传，只能换商宽。</li><li>拿家宽跑pcdn的真的该死啊！！！！按照以前千兆能有个100m的上传的。</li></ul><p>中间调试的时候发现了一个华硕路由器非常坑的地方，在 <code>系统管理 - 系统设置 - 开启 WAN 中断的浏览器导页通知</code> 这个配置是默认开启的，也就是说当你的路由器wan口没有互联网连接时，访问路由器就会跳转到配置网络的导航页，哪怕你是访问的光猫。刚好新的2.5g猫没有wifi，装维师傅想连路由器Wi-Fi去配置光猫，结果就到了路由器页面。</p><h3 id="一个非常奇怪的问题"><a href="#一个非常奇怪的问题" class="headerlink" title="一个非常奇怪的问题"></a>一个非常奇怪的问题</h3><p>群晖和路由器都是挂在光猫下各自拨号上网，群晖第二个网口（固定了ip）接入路由器给路由器下设备访问。<br>群晖网络服务顺序是 <code>拨号 - 路由器 - 光猫</code> 。<br>群晖配置了ddns域名，在路由器下的设备无法访问群晖的ddns域名，也无法访问群晖获取到的公网ip。<br>设备配置host将ddns域名指向群晖在路由器下的固定ip，能够正常访问群晖。</p><p>排查：</p><ul><li>路由器下设备能正常解析到群晖公网IP。</li><li>traceroute 群晖公网ip，发现后面几跳会到路由器第二wan配置的iptv内网ip，很奇怪。</li><li>群晖部署AdGuard DNS，配置到路由器的DNS上，路由器下设备能正常解析域名。</li><li>AdGuard DNS配置dns重写，将ddns域名重写到群晖路由器下的固定IP，路由器设备仍然解析到的是公网IP。</li></ul><p>这个问题一直没解决，等后续有时间了再排查。</p><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/yet-another-blog-migration">博客迁移到Hexo </a></span><span class="next"><a href="/posts/install-debian-12.5-on-surface-book-2">Surface Book 2 安装 Debian 12.5</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>