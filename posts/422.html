<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>JAVA三目运算中隐藏的自动拆装箱 - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>JAVA三目运算中隐藏的自动拆装箱</h1><div><time>2018-11-11</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/dev/">dev</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/java/">java</a></span></div></div></header><p>最近修改线上bug的时候排查了一个十分隐藏的bug，直接上代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Integer</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-type">Integer</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> flag ? a : <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>乍一看是没什么毛病的，但是已运行就会发现报空指针，在idea里面也会警告可能有空指针，这是什么原因呢？直接看字节码：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">0</span>: aconst_null<br><span class="hljs-attribute">1</span>: astore_1<br><span class="hljs-attribute">2</span>: iconst_1<br><span class="hljs-attribute">3</span>: istore_2<br><span class="hljs-attribute">4</span>: iload_2<br><span class="hljs-attribute">5</span>: ifeq          15<br><span class="hljs-attribute">8</span>: aload_1<br><span class="hljs-attribute">9</span>: invokevirtual <span class="hljs-comment">#2             // Method java/lang/Integer.intValue:()I</span><br><span class="hljs-attribute">12</span>: goto          16<br><span class="hljs-attribute">15</span>: iconst_0<br><span class="hljs-attribute">16</span>: invokestatic  <span class="hljs-comment">#3            // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="hljs-attribute">19</span>: astore_3<br><span class="hljs-attribute">20</span>: getstatic     <span class="hljs-comment">#4            // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="hljs-attribute">23</span>: aload_3<br><span class="hljs-attribute">24</span>: invokevirtual <span class="hljs-comment">#5            // Method java/io/PrintStream.println:(Ljava/lang/Object;)V</span><br><span class="hljs-attribute">27</span>: return<br></code></pre></td></tr></table></figure><p>可以看到字节码中调用了Integer.valueOf()方法，因为我们代码中一个值使用的是0（基本数据类型int），编译器就会进行自动拆装箱（成int），<br>虽然三目运算的后面逻辑不会执行，但是隐藏的自动拆装箱会执行Integer.valueOf()方法，也就有了空指针异常。</p><p>为了进一步验证存在自动拆装箱，把代码修改一下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Integer</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-type">Integer</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> flag ? a : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Integer</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>再看字节码：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-attribute">0</span>: aconst_null<br><span class="hljs-attribute">1</span>: astore_1<br><span class="hljs-attribute">2</span>: iconst_1<br><span class="hljs-attribute">3</span>: istore_2<br><span class="hljs-attribute">4</span>: iload_2<br><span class="hljs-attribute">5</span>: ifeq          12<br><span class="hljs-attribute">8</span>: aload_1<br><span class="hljs-attribute">9</span>: goto          20<br><span class="hljs-attribute">12</span>: new           <span class="hljs-comment">#2           // class java/lang/Integer</span><br><span class="hljs-attribute">15</span>: dup<br><span class="hljs-attribute">16</span>: iconst_0<br><span class="hljs-attribute">17</span>: invokespecial <span class="hljs-comment">#3           // Method java/lang/Integer.&quot;&lt;init&gt;&quot;:(I)V</span><br><span class="hljs-attribute">20</span>: astore_3<br><span class="hljs-attribute">21</span>: getstatic     <span class="hljs-comment">#4           // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="hljs-attribute">24</span>: aload_3<br><span class="hljs-attribute">25</span>: invokevirtual <span class="hljs-comment">#5           // Method java/io/PrintStream.println:(Ljava/lang/Object;)V</span><br></code></pre></td></tr></table></figure><p>可以看到，由于重新创建了一个Integer对象，并没有基本类型的存在，也就不存在自动拆装箱，修改过后的代码也就不会有问题了，但是idea的警告依旧存在。</p><p>这是一个非常隐蔽，也非常容易忽略和踩坑的一个地方，三目运算符的使用应该保证后面的值都是常量，或者统一类型，不然就会出现上面的情况。<br>更甚三目运算符本身提供的作用也不过是为了简化逻辑，在其中放入过多的逻辑判断也就违背了其初衷。</p><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/486">EFFECTIVE JAVA 3RD EDITION — 第六章 枚举与注解 </a></span><span class="next"><a href="/posts/407">TOMCAT 8 COOKIEPROCESSOR 实现变化</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>