<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>Cloud Native Monitoring Notes - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>Cloud Native Monitoring Notes</h1><div><time>2022-05-25</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/dev/">dev</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/notes/">notes</a></span></div></div></header><h2 id="Cloud-Native-Monitoring"><a href="#Cloud-Native-Monitoring" class="headerlink" title="Cloud Native Monitoring"></a>Cloud Native Monitoring</h2><p><a target="_blank" rel="noopener" href="https://landscape.cncf.io/guide#observability-and-analysis">Observability and Analysis</a></p><p><strong>Observability</strong> 是指一种 从系统外部输出能够理解到系统的程度 的 系统特性。<br>比如我们可以从系统的cpu占用，内存使用量等来观察计算机。</p><p><strong>Analysis</strong> 指的是分析这些可观测数据并进行理解。</p><p>为了确保系统不中断，需要对系统的各个方面进行观测和分析。<br>Observability和Analysis工具涵盖了logging, monitoring, tracing, 和 chaos engineering。</p><h2 id="Monitoring"><a href="#Monitoring" class="headerlink" title="Monitoring"></a>Monitoring</h2><p>监控是指对系统进行检测以收集、汇总和分析日志和指标，以提高我们对其行为的理解。<br>而一个好的监控能够让操作人员快速响应异常，甚至能够自动的进行处理，同时也能够监控系统的健康程度，甚至系统的任何变动。</p><p>同时，监控是一个高效系统重要的组成部分。</p><table><thead><tr><th>Buzzwords</th><th>CNCF Projects</th></tr></thead><tbody><tr><td>Monitoring<br>Time series<br>Alerting<br>Metrics</td><td>Prometheus (graduated)<br>Cortex (incubating)<br>Thanos (incubating)<br>Fonio (sandbox)<br>Kuberhealthy (sandbox)<br>OpenMetrics (sandbox)<br>Pixie (sandbox)<br>Skooner (sandbox)<br>Trickster (sandbox)</td></tr></tbody></table><h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>Architecture：<br><img src="https://prometheus.io/assets/architecture.png"></p><p>组件：</p><ul><li>抓取，读取时序数据的后端服务；</li><li>客户端；</li><li>支持短生命周期任务的 <code>Pushgateway</code> ；</li><li>用于服务导出数据的 <code>Exporter</code> ；</li><li>告警系统；</li><li>多种支持工具；</li></ul><h4 id="Metric-DataModel"><a href="#Metric-DataModel" class="headerlink" title="Metric DataModel"></a>Metric DataModel</h4><p>Metric Definition：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125; value <span class="hljs-string">[timestamp]</span><br># e.g.<br>api_http_requests_total&#123;method=<span class="hljs-string">&quot;<span class="hljs-keyword">POST</span>&quot;</span>, handler=<span class="hljs-string">&quot;/messages&quot;</span>&#125; <span class="hljs-number">5</span> <span class="hljs-number">1395066363000</span><br></code></pre></td></tr></table></figure><h4 id="Text-Data-Format"><a href="#Text-Data-Format" class="headerlink" title="Text Data Format"></a><a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/exposition_formats/#text-format-details">Text Data Format</a></h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.</span><br><span class="hljs-comment"># TYPE process_cpu_seconds_total counter</span><br><span class="hljs-attribute">process_cpu_seconds_total</span> <span class="hljs-number">1871</span>.<span class="hljs-number">15625</span><br></code></pre></td></tr></table></figure><p>文本协议基于 <code>行</code>，忽略空行，使用 <code>\n</code> 分割，最后一行必须是换行符。</p><p><code>#</code> 是注释行，但是如果后面是 <code>HELP</code> 和 <code>TYPE</code>：</p><ul><li><code>HELP</code> 那么后面需要一个 metric 名称，其他则是相关的注释，同时一个 metric 只能有一个 <code>HELP</code> 行；</li><li><code>TYPE</code> 后面需要一个 metric 名称，紧接着是 metric 类型，类型是非必填，如果不填写则默认为 <code>untyped</code>；</li></ul><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"># 时间戳是UTC毫秒时间戳<br>metric_name [ <span class="hljs-string">&quot;&#123;&quot;</span> label_name <span class="hljs-string">&quot;=&quot;</span> `&quot;` label_value `&quot;` &#123; <span class="hljs-string">&quot;,&quot;</span> label_name <span class="hljs-string">&quot;=&quot;</span> `&quot;` label_value `&quot;` &#125; [ <span class="hljs-string">&quot;,&quot;</span> ] <span class="hljs-string">&quot;&#125;&quot;</span> ] value [ timestamp ]<br></code></pre></td></tr></table></figure><h4 id="Metric-Types"><a href="#Metric-Types" class="headerlink" title="Metric Types"></a><a target="_blank" rel="noopener" href="https://prometheus.io/docs/concepts/metric_types/">Metric Types</a></h4><p><strong><em>Counter</em></strong></p><p>是一个逐渐累加的metric数据，比如已完成请求数量等等，不能使用counter来表示一个可以减少的数据，比如当前线程数量。</p><p><strong><em>Gauge</em></strong></p><p>是一个可任意增减的metric数据，且仅能是一个数字，比如内存使用量、温度等等。</p><p><strong><em>Histogram</em></strong></p><p>Histogram包含了一个时间段内以同一个前缀命名的多个时序数据：</p><ul><li><code>&lt;basename&gt;_bucket&#123;le=&quot;&lt;upper inclusive bound&gt;&quot;&#125;</code> 观察到的累计计数，可以理解成小于某个值的统计数量；</li><li><code>&lt;basename&gt;_sum</code> 观察值总和；</li><li><code>&lt;basename&gt;_count</code> 观察到的事件总数；</li></ul><p><strong><em>Summary</em></strong></p><p>Summary包含一个时间段内以同一个前缀命名的多个时序数据：</p><ul><li><code>&lt;basename&gt;&#123;quantile=&quot;&lt;p&gt;&quot;&#125;</code> <code>q-quantiles (0 ≤ q ≤ 1)</code> 观察到事件的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E4%BD%8D%E6%95%B0">q分位数</a> ；</li><li><code>&lt;basename&gt;_sum</code> 观察值总和；</li><li><code>&lt;basename&gt;_count</code> 观察到的事件总数；</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span><br><span class="hljs-comment"># TYPE go_gc_duration_seconds summary</span><br><span class="hljs-attribute">go_gc_duration_seconds</span>&#123;quantile=<span class="hljs-string">&quot;0&quot;</span>&#125; <span class="hljs-number">2</span>.<span class="hljs-number">83</span>e-<span class="hljs-number">05</span><br><span class="hljs-attribute">go_gc_duration_seconds</span>&#123;quantile=<span class="hljs-string">&quot;0.25&quot;</span>&#125; <span class="hljs-number">6</span>.<span class="hljs-number">83</span>e-<span class="hljs-number">05</span><br><span class="hljs-attribute">go_gc_duration_seconds</span>&#123;quantile=<span class="hljs-string">&quot;0.5&quot;</span>&#125; <span class="hljs-number">8</span>.<span class="hljs-number">95</span>e-<span class="hljs-number">05</span><br><span class="hljs-attribute">go_gc_duration_seconds</span>&#123;quantile=<span class="hljs-string">&quot;0.75&quot;</span>&#125; <span class="hljs-number">0</span>.<span class="hljs-number">0001084</span><br><span class="hljs-attribute">go_gc_duration_seconds</span>&#123;quantile=<span class="hljs-string">&quot;1&quot;</span>&#125; <span class="hljs-number">0</span>.<span class="hljs-number">000557999</span><br><span class="hljs-attribute">go_gc_duration_seconds_sum</span> <span class="hljs-number">0</span>.<span class="hljs-number">203637424</span><br><span class="hljs-attribute">go_gc_duration_seconds_count</span> <span class="hljs-number">1894</span><br></code></pre></td></tr></table></figure><p>Histogram 和 Summary 差异：</p><ul><li>都包含了sum和count指标；</li><li>Summary直接存储分位值，而Histogram需要进行计算；</li></ul><h4 id="JOBS-AND-INSTANCES"><a href="#JOBS-AND-INSTANCES" class="headerlink" title="JOBS AND INSTANCES"></a>JOBS AND INSTANCES</h4><p><code>instance</code> 是指一个可以抓取数据的 <code>endpoint</code>，通常也是对应一个进程。</p><p>具有相同目的的 <code>instance</code> 称为一个 <code>job</code>。</p><ul><li>job: api-server<ul><li>instance 1: 1.2.3.4:5670</li><li>instance 2: 1.2.3.4:5671</li><li>instance 3: 5.6.7.8:5670</li><li>instance 4: 5.6.7.8:5671</li></ul></li></ul><h4 id="ServiceMonitor-PodMonitor"><a href="#ServiceMonitor-PodMonitor" class="headerlink" title="ServiceMonitor &amp; PodMonitor"></a>ServiceMonitor &amp; PodMonitor</h4><p>prometheus通过 <code>ServiceMonitor</code> 监控 service，通过 <code>PodMonitor</code> 来监控 pod。</p><p>默认配置的是可以获取集群中所有的monitor资源，前提是配置好权限，如果需要限制prometheus监控的monitor范围，<br>可以在 <a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus/blob/main/manifests/prometheus-prometheus.yaml">prometheus-prometheus.yaml</a><br>中进行配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Prometheus</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">prometheus:</span> <span class="hljs-string">k8s</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">k8s</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br><span class="hljs-comment"># 默认没有进行配置，可以对所有 ns 和 monitor进行监控</span><br>  <span class="hljs-attr">serviceMonitorNamespaceSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">serviceMonitorSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">podMonitorNamespaceSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">podMonitorSelector:</span> &#123;&#125;<br></code></pre></td></tr></table></figure><h3 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h3><p>kubernetes 部署方式支持 <code>operator</code> 和 <code>kube-prometheus</code>，<br>这里使用 <a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus">kube-prometheus</a> 来进行部署。</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta"># 安装 operator</span><br>kubectl <span class="hljs-keyword">create</span> -f manifests/setup<br><span class="hljs-meta"># 安装 prometheus 服务端和各个组件</span><br>kubectl <span class="hljs-keyword">create</span> -f manifests/<br></code></pre></td></tr></table></figure><p>需要注意的是上面的配置文件创建在 <code>monitoring</code> 命名空间下，同时为了支持跨 ns 的监控需要修改服务端的权限配置，<br><a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/kube-prometheus/blob/main/manifests/prometheus-clusterRole.yaml">prometheus-clusterRole.yaml</a> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-k8s</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">nodes/metrics</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">nonResourceURLs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/metrics</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment"># 资源和操作权限</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br></code></pre></td></tr></table></figure><p>部署成功后默认配置了下面的 <code>service</code> ：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">NAME</span>                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE<br><span class="hljs-attribute">alertmanager</span>-main       ClusterIP   <span class="hljs-number">10.233.43.107</span>   &lt;none&gt;        <span class="hljs-number">9093</span>/TCP                     <span class="hljs-number">9</span>d<br><span class="hljs-attribute">alertmanager</span>-operated   ClusterIP   None            &lt;none&gt;        <span class="hljs-number">9093</span>/TCP,<span class="hljs-number">9094</span>/TCP,<span class="hljs-number">9094</span>/UDP   <span class="hljs-number">9</span>d<br><span class="hljs-attribute">grafana</span>                 ClusterIP   <span class="hljs-number">10.233.24.21</span>    &lt;none&gt;        <span class="hljs-number">3000</span>/TCP                     <span class="hljs-number">9</span>d<br><span class="hljs-attribute">kube</span>-state-metrics      ClusterIP   None            &lt;none&gt;        <span class="hljs-number">8443</span>/TCP,<span class="hljs-number">9443</span>/TCP            <span class="hljs-number">9</span>d<br><span class="hljs-attribute">node</span>-exporter           ClusterIP   None            &lt;none&gt;        <span class="hljs-number">9100</span>/TCP                     <span class="hljs-number">9</span>d<br><span class="hljs-attribute">prometheus</span>-adapter      ClusterIP   <span class="hljs-number">10.233.7.187</span>    &lt;none&gt;        <span class="hljs-number">443</span>/TCP                      <span class="hljs-number">9</span>d<br><span class="hljs-attribute">prometheus</span>-k8s          ClusterIP   <span class="hljs-number">10.233.31.173</span>   &lt;none&gt;        <span class="hljs-number">9090</span>/TCP                     <span class="hljs-number">9</span>d<br><span class="hljs-attribute">prometheus</span>-operated     ClusterIP   None            &lt;none&gt;        <span class="hljs-number">9090</span>/TCP                     <span class="hljs-number">9</span>d<br><span class="hljs-attribute">prometheus</span>-operator     ClusterIP   None            &lt;none&gt;        <span class="hljs-number">8443</span>/TCP                     <span class="hljs-number">9</span>d<br></code></pre></td></tr></table></figure><p>需要关注的是下面几个 <code>service</code> ：</p><ul><li><code>alertmanager-main</code>；</li><li><code>grafana</code>；</li><li><code>node-exporter</code> k8s集群节点 <code>exporter</code> （每个节点都部署了一个）；</li><li><code>prometheus-k8s</code>；</li></ul><p>先将所有的ui服务通过ingress暴露出来：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># ingress</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">monitor-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">annotations:</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span><br>        <span class="hljs-attr">paths:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">backend:</span><br>              <span class="hljs-attr">serviceName:</span> <span class="hljs-string">prometheus-k8s</span><br>              <span class="hljs-attr">servicePort:</span> <span class="hljs-string">web</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-string">prome.minei.test</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span><br>        <span class="hljs-attr">paths:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">backend:</span><br>              <span class="hljs-attr">serviceName:</span> <span class="hljs-string">grafana</span><br>              <span class="hljs-attr">servicePort:</span> <span class="hljs-string">http</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-string">grafana.minei.test</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span><br>        <span class="hljs-attr">paths:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">backend:</span><br>              <span class="hljs-attr">serviceName:</span> <span class="hljs-string">alertmanager-main</span><br>              <span class="hljs-attr">servicePort:</span> <span class="hljs-string">web</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-string">alert.minei.test</span><br></code></pre></td></tr></table></figure><h3 id="Querying"><a href="#Querying" class="headerlink" title="Querying"></a>Querying</h3><h4 id="PromQL数据类型："><a href="#PromQL数据类型：" class="headerlink" title="PromQL数据类型："></a>PromQL数据类型：</h4><ul><li>Instant Vector 一组时间序列，每个时间序列包含一个样本，所有时间序列都共享相同的时间戳；</li><li>Range Vector 一组时间序列，包含每个时间序列随时间变化的数据点范围</li><li>Scalar 简单的数字浮点值</li><li>String 字符串，尚未使用</li></ul><h4 id="字面量："><a href="#字面量：" class="headerlink" title="字面量："></a>字面量：</h4><ul><li><code>&quot;</code> <code>&#39;</code> <code>`</code> 都可以用来声明字符串；</li><li><code>23</code> <code>-2.43</code> <code>3.4e-9</code> <code>0x8f</code> <code>-Inf</code> <code>NaN</code> 浮点字面量；</li></ul><h4 id="选择器："><a href="#选择器：" class="headerlink" title="选择器："></a>选择器：</h4><ul><li>瞬时向量选择器<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">node_cpu_seconds_total&#123;<span class="hljs-attribute">instance</span>=<span class="hljs-string">&quot;master-1-145&quot;</span>, <span class="hljs-attribute">cpu</span>=<span class="hljs-string">&quot;1&quot;</span>&#125;<br></code></pre></td></tr></table></figure><ul><li>运算符支持 <code>=</code> <code>!=</code> <code>=~</code> <code>!~</code>，后面两种是<a target="_blank" rel="noopener" href="https://github.com/google/re2/wiki/Syntax">正则表达式</a>；</li><li>同时支持 <code>__name__</code> 来筛选metric；<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 筛选所有test开头的metric</span><br>&#123;<span class="hljs-attribute">__name__</span>=~&quot;test.*&quot;&#125;<br></code></pre></td></tr></table></figure></li></ul></li><li>范围向量选择器，<code>[]</code> 来声明时间范围，选择声明范围内的数据：<ul><li>ms - milliseconds</li><li>s - seconds</li><li>m - minutes</li><li>h - hours</li><li>d - days - assuming a day has always 24h</li><li>w - weeks - assuming a week has always 7d</li><li>y - years - assuming a year has always 365d</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 筛选master-145上1m10s内cpu的使用时间</span><br><span class="hljs-attribute">node_cpu_seconds_total</span>&#123;instance=<span class="hljs-string">&quot;master-1-145&quot;</span>&#125;[<span class="hljs-number">1</span>m10s]<br></code></pre></td></tr></table></figure></li><li><code>offset</code> 修饰符，将选择器中当前时间进行偏移，必须紧跟在选择器之后；<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 如果当前时间是 21：00 那么下面查询的就是 20：00 之前的数据</span><br><span class="hljs-attribute">node_cpu_seconds_total</span>&#123;instance=<span class="hljs-string">&quot;master-1-145&quot;</span>&#125; offset <span class="hljs-number">1</span>h<br><span class="hljs-comment"># 不合法</span><br><span class="hljs-attribute">sum</span>(node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;master-1-145&quot;</span>&#125;) offset <span class="hljs-number">1</span>m<br></code></pre></td></tr></table></figure></li><li><code>@</code> 修饰符，用来选择某个时间戳的数据，也需要紧跟在选择器之后；<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">node_cpu_seconds_total</span>&#123;instance=<span class="hljs-string">&quot;master-1-145&quot;</span>&#125; @ <span class="hljs-number">1609746000</span><br><span class="hljs-comment"># 不合法</span><br><span class="hljs-attribute">sum</span>(node_cpu_seconds_total&#123;instance=<span class="hljs-string">&quot;master-1-145&quot;</span>&#125;) @ <span class="hljs-number">1609746000</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h4><ul><li>向量匹配，<code>ignoring</code> 可以在匹配时忽略指定标签，而 <code>on</code> 可以指定匹配的标签；<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs perl">method_code:http_errors:rate5m&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">get</span>&quot;, <span class="hljs-title">code</span>=&quot;500&quot;&#125;  24</span><br><span class="hljs-function"><span class="hljs-title">method_code</span>:<span class="hljs-title">http_errors</span>:<span class="hljs-title">rate5m</span></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">get</span>&quot;, <span class="hljs-title">code</span>=&quot;404&quot;&#125;  30</span><br><span class="hljs-function"><span class="hljs-title">method_code</span>:<span class="hljs-title">http_errors</span>:<span class="hljs-title">rate5m</span></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">put</span>&quot;, <span class="hljs-title">code</span>=&quot;501&quot;&#125;  3</span><br><span class="hljs-function"><span class="hljs-title">method_code</span>:<span class="hljs-title">http_errors</span>:<span class="hljs-title">rate5m</span></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">post</span>&quot;, <span class="hljs-title">code</span>=&quot;500&quot;&#125; 6</span><br><span class="hljs-function"><span class="hljs-title">method_code</span>:<span class="hljs-title">http_errors</span>:<span class="hljs-title">rate5m</span></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">post</span>&quot;, <span class="hljs-title">code</span>=&quot;404&quot;&#125; 21</span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-title">method</span>:<span class="hljs-title">http_requests</span>:<span class="hljs-title">rate5m</span></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">get</span>&quot;&#125;  600</span><br><span class="hljs-function"><span class="hljs-title">method</span>:<span class="hljs-title">http_requests</span>:<span class="hljs-title">rate5m</span></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">del</span>&quot;&#125;  34</span><br><span class="hljs-function"><span class="hljs-title">method</span>:<span class="hljs-title">http_requests</span>:<span class="hljs-title">rate5m</span></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">post</span>&quot;&#125; 120</span><br></code></pre></td></tr></table></figure><ul><li>一对一匹配，如果有相同的标签集合和值，那么他们就是匹配的；</li></ul><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">method_code:http_errors:rate5m<span class="hljs-comment">&#123;code=&quot;500&quot;&#125;</span> / ignoring(code) <span class="hljs-keyword">method</span>:http_requests:rate5m<br># 计算 <span class="hljs-number">500</span> 请求比例<br># 由于 <span class="hljs-keyword">method</span> 为 <span class="hljs-title function_">put</span> 和 <span class="hljs-title function_">del</span> 的样本找不到匹配项，因此不会出现在结果当中。<br><span class="hljs-comment">&#123;method=&quot;get&quot;&#125;</span>  0.04            //  24 / 600<br><span class="hljs-comment">&#123;method=&quot;post&quot;&#125;</span> 0.05            //   6 / 120<br></code></pre></td></tr></table></figure><ul><li>一对多&#x2F;多对一匹配，一侧的元素可以与另一侧的多个元素匹配上，可以使用 <code>groupe_left</code> <code>group_right</code> 来控制以哪边为基准返回结果。</li></ul><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl">method_code:http_errors:rate5m / ignoring(code) group_left <span class="hljs-function"><span class="hljs-keyword">method</span>:<span class="hljs-title">http_requests</span>:<span class="hljs-title">rate5m</span></span><br><span class="hljs-function"># 左边包含2个标签，右边包含1个标签，无法匹配</span><br><span class="hljs-function"># 忽略 <span class="hljs-title">code</span> 标签则能够进行匹配</span><br><span class="hljs-function"># 这个时候左边是多的一边，<span class="hljs-title">group_left</span> 使用左边为基准返回</span><br><span class="hljs-function"></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">get</span>&quot;, <span class="hljs-title">code</span>=&quot;500&quot;&#125;  0.04            //  24 / 600</span><br><span class="hljs-function"></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">get</span>&quot;, <span class="hljs-title">code</span>=&quot;404&quot;&#125;  0.05            //  30 / 600</span><br><span class="hljs-function"></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">post</span>&quot;, <span class="hljs-title">code</span>=&quot;500&quot;&#125; 0.05            //   6 / 120</span><br><span class="hljs-function"></span>&#123;<span class="hljs-function"><span class="hljs-keyword">method</span>=&quot;<span class="hljs-title">post</span>&quot;, <span class="hljs-title">code</span>=&quot;404&quot;&#125; 0.175           //  21 / 120</span><br></code></pre></td></tr></table></figure></li><li>算数运算符，<code>+</code> <code>-</code> <code>*</code> <code>/</code> <code>%</code> <code>^</code>，算数计算只能用于标量&#x2F;标量，瞬时向量&#x2F;标量，瞬时向量&#x2F;瞬时向量；<ul><li>标量&#x2F;标量</li><li>瞬时向量&#x2F;标量：向量每个值都和标量作运算</li><li>瞬时向量&#x2F;瞬时向量</li></ul></li><li>比较运算符，<code>==</code> <code>!=</code> <code>&lt;</code> <code>&gt;</code> <code>&gt;=</code> <code>&lt;=</code>；</li><li>逻辑运算符，<code>and</code> <code>or</code> <code>unless</code>，只用于瞬时向量；<ul><li><code>v1 and v2</code> 返回v1中完全匹配v2的元素集合，交集</li><li><code>v1 or v2</code> 返回v1和v2中没有与v1匹配上的元素集合，并集</li><li><code>v1 unless v2</code> 返回v1中没有与v2匹配到的元素集合，差集</li></ul></li><li>聚合运算；<ul><li>sum</li><li>min</li><li>max</li><li>avg</li><li>group (all values in the resulting vector are 1)</li><li>stddev 标准差</li><li>stdvar 方差</li><li>count 计数</li><li>count_values 统计出现的次数<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">count_values</span><span class="hljs-params">(<span class="hljs-string">&quot;goversion&quot;</span>, node_exporter_build_info)</span></span><br></code></pre></td></tr></table></figure></li><li>bottomk 最小k个</li><li>topk 最大k个</li><li>quantile q分位数</li><li><code>without</code> <code>by</code>，可以理解成不按照xx分组，按照xx分组：</li></ul><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lisp">sum without (<span class="hljs-name">job</span>) (<span class="hljs-name">go_goroutines</span>)<br>sum by (<span class="hljs-name">instance</span>, job) (<span class="hljs-name">go_goroutines</span>)<br>sum by (<span class="hljs-name">job</span>) (<span class="hljs-name">go_goroutines</span>)<br></code></pre></td></tr></table></figure></li></ul><p>运算符优先级：</p><ol><li>^</li><li>*, &#x2F;, %, atan2</li><li>+, -</li><li>&#x3D;&#x3D;, !&#x3D;, &lt;&#x3D;, &lt;, &gt;&#x3D;, &gt;</li><li>and, unless</li><li>or</li></ol><h4 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/functions/">Functions</a></h4><p><strong><em>Counter指标增长率</em></strong></p><ul><li><code>increase(v range-vector)</code> 计算范围向量内的增长量；</li><li><code>rate(v range-vector)</code> 计算范围向量内每秒增长率。应该只用于Counters；</li><li><code>irate(v range-vector)</code> 计算范围向量内每秒瞬时增长率，使用的是范围向量最后2个样本数据进行计算；</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">rate</span><span class="hljs-params">(go_memstats_frees_total[<span class="hljs-number">5</span>m])</span></span><br><span class="hljs-function"><span class="hljs-title">increase</span><span class="hljs-params">(go_memstats_frees_total[<span class="hljs-number">5</span>m])</span></span> / <span class="hljs-number">300</span><br><span class="hljs-function"><span class="hljs-title">irate</span><span class="hljs-params">(go_memstats_frees_total[<span class="hljs-number">5</span>m])</span></span><br></code></pre></td></tr></table></figure><p><code>increase()</code> <code>rate()</code> 更偏向于平均增长率，而 <code>irate()</code> 是瞬时增长率，各自适合的场景不一样。</p><p><strong><em>Gauge指标</em></strong></p><ul><li><code>predict_linear(v range-vector, t scalar)</code> 预测向量v未来t秒内数据，使用的是 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Simple_linear_regression">简单线性回归</a></li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">predict_linear</span><span class="hljs-params">(go_memstats_alloc_bytes[<span class="hljs-number">10</span>m], <span class="hljs-number">3600</span>)</span></span><br></code></pre></td></tr></table></figure><p><strong><em>Histogram指标分位数</em></strong></p><ul><li><code>histogram_quantile(φ scalar, b instant-vector)</code> 计算瞬时向量b的φ分位数</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">histogram_quantile</span>(<span class="hljs-number">0</span>.<span class="hljs-number">9</span>, rate(apiserver_response_sizes_bucket[<span class="hljs-number">10</span>m]))<br></code></pre></td></tr></table></figure><p><strong><em>聚合函数</em></strong></p><p><code>&lt;aggregation&gt;_over_time()</code>：</p><ul><li><code>avg_over_time(range-vector)</code> : 平均值</li><li><code>min_over_time(range-vector)</code> : 最小值</li><li><code>max_over_time(range-vector)</code> : 最大值</li><li><code>sum_over_time(range-vector)</code> : 求和</li><li><code>count_over_time(range-vector)</code> : 计数</li><li><code>quantile_over_time(scalar, range-vector)</code> : φ分位数</li><li><code>stddev_over_time(range-vector)</code> : 总标准差</li><li><code>stdvar_over_time(range-vector)</code> : 总标准方差</li><li><code>last_over_time(range-vector)</code> : 最近一个采样点数据</li><li><code>present_over_time(range-vector)</code> : 范围内值为1的时间序列</li></ul><h3 id="Exporters"><a href="#Exporters" class="headerlink" title="Exporters"></a>Exporters</h3><p>官方支持多种硬件、数据库、消息系统、存储等等的支持，可查看官方 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/instrumenting/exporters/">支持列表</a> 。</p><p><code>exporter</code> 用于导出 metric 数据，<code>prometheus</code> 服务来拉取。</p><h4 id="Node-Exporter"><a href="#Node-Exporter" class="headerlink" title="Node Exporter"></a>Node Exporter</h4><p>上面提到的 <code>kube-prometheus</code> 部署方式已经默认在集群内部部署了集群节点个数的 <code>node-exporter</code>。<br>配置文件：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">node</span><span class="hljs-title">-exporter-clusterRole</span>.yaml<br><span class="hljs-keyword">node</span><span class="hljs-title">-exporter-clusterRoleBinding</span>.yaml<br><span class="hljs-keyword">node</span><span class="hljs-title">-exporter-daemonset</span>.yaml<br><span class="hljs-keyword">node</span><span class="hljs-title">-exporter-prometheusRule</span>.yaml<br><span class="hljs-keyword">node</span><span class="hljs-title">-exporter-service</span>.yaml<br><span class="hljs-keyword">node</span><span class="hljs-title">-exporter-serviceAccount</span>.yaml<br><span class="hljs-keyword">node</span><span class="hljs-title">-exporter-serviceMonitor</span>.yaml<br></code></pre></td></tr></table></figure><p><strong>监控集群外虚拟机</strong></p><p><a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter">node exporter</a> 也支持安装包部署，部署成功默认在 <code>9100</code> 端口暴露 metric 数据。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl localhost:9100<br></code></pre></td></tr></table></figure><p>配置 <code>prometheus</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">external-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">external-server</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">9100</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9100</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Endpoints</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">external-server</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">external-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">subsets:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">addresses:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.125</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.129</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.179</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.119</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">9100</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">external-server</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">external-server</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">endpoints:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-string">metrics</span><br>    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span><br>    <span class="hljs-attr">scheme:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">external-server</span><br>  <span class="hljs-attr">namespaceSelector:</span><br>    <span class="hljs-attr">matchNames:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">monitoring</span><br></code></pre></td></tr></table></figure><p>可以在 <a target="_blank" rel="noopener" href="http://prome.minei.test/service-discovery">service-discovery</a> 进行查看。</p><h4 id="JMX-Exporter"><a href="#JMX-Exporter" class="headerlink" title="JMX Exporter"></a>JMX Exporter</h4><p><a target="_blank" rel="noopener" href="https://github.com/prometheus/jmx_exporter">JMX Exporter</a> 是一个基于 JVM 应用的一个 exporter，<br>通过javaagent的方式来进行监控，同时需要配置目标应用的jmx：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 使用启动参数配置 jmx</span><br>-Dcom.sun.management.jmxremote<br>-Dcom.sun.management.jmxremote.<span class="hljs-attribute">port</span>=9010<br>-Dcom.sun.management.jmxremote.rmi.<span class="hljs-attribute">port</span>=9010<br>-Dcom.sun.management.jmxremote.local.<span class="hljs-attribute">only</span>=<span class="hljs-literal">false</span><br>-Dcom.sun.management.jmxremote.<span class="hljs-attribute">authenticate</span>=<span class="hljs-literal">false</span><br>-Dcom.sun.management.jmxremote.<span class="hljs-attribute">ssl</span>=<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>配置agent：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment"># 8080指定的是暴露metric数据的端口</span><br>-<span class="hljs-symbol">javaagent:</span>/path/to/your/agent/jmx_prometheus_javaagent<span class="hljs-number">-0.16</span>.<span class="hljs-number">1</span>.jar=<span class="hljs-number">8080</span><span class="hljs-symbol">:/path/to/your/exporter/config/jmx-exporter-config</span>.yaml<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p>exporter配置：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">startDelaySeconds:</span> <span class="hljs-number">0</span><br><span class="hljs-comment"># 这里配置的是的目标jmx</span><br><span class="hljs-attr">hostPort:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:9010</span><br><span class="hljs-attr">username:</span> <br><span class="hljs-attr">password:</span> <br><span class="hljs-comment"># jmxUrl: service:jmx:rmi:///jndi/rmi://127.0.0.1:1234/jmxrmi</span><br><span class="hljs-attr">ssl:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">lowercaseOutputName:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">lowercaseOutputLabelNames:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">whitelistObjectNames:</span> [<span class="hljs-string">&quot;org.apache.cassandra.metrics:*&quot;</span>]<br><span class="hljs-attr">blacklistObjectNames:</span> [<span class="hljs-string">&quot;org.apache.cassandra.metrics:type=ColumnFamily,*&quot;</span>]<br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">pattern:</span> <span class="hljs-string">&#x27;org.apache.cassandra.metrics&lt;type=(\w+), name=(\w+)&gt;&lt;&gt;Value: (\d+)&#x27;</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">cassandra_$1_$2</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">$3</span><br>    <span class="hljs-attr">valueFactor:</span> <span class="hljs-number">0.001</span><br>    <span class="hljs-attr">labels:</span> &#123;&#125;<br>    <span class="hljs-attr">help:</span> <span class="hljs-string">&quot;Cassandra metric $1 $2&quot;</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">GAUGE</span><br>    <span class="hljs-attr">attrNameSnakeCase:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p>配置 <code>ServiceMonitor</code> ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">less-svc</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">java-app:</span> <span class="hljs-string">less-svc</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">jmx</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">external-app:</span> <span class="hljs-string">less-svc</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Endpoints</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">less-svc</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">java-app:</span> <span class="hljs-string">less-svc</span><br>    <span class="hljs-attr">external-app:</span> <span class="hljs-string">less-svc</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">subsets:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">addresses:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.39</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">jmx</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">java-app</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">java-app:</span> <span class="hljs-string">less-svc</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">endpoints:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-string">jmx</span><br>    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span><br>    <span class="hljs-attr">scheme:</span> <span class="hljs-string">http</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">java-app:</span> <span class="hljs-string">less-svc</span><br>  <span class="hljs-attr">namespaceSelector:</span><br>    <span class="hljs-attr">matchNames:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">monitoring</span><br></code></pre></td></tr></table></figure><h3 id="How-To-Debug-ServiceMonitor"><a href="#How-To-Debug-ServiceMonitor" class="headerlink" title="How To Debug ServiceMonitor ?"></a>How To Debug ServiceMonitor ?</h3><p><img src="https://github.com/prometheus-operator/prometheus-operator/raw/main/Documentation/custom-metrics-elements.png"></p><ol><li>检查servicemonitor标签是否成功被Prometheus成功筛选到；</li><li>检查service的标签是否成功被servicemonitor标签筛选到；</li><li>检查Prometheus对目标service是否有权限；</li><li>目标service是否能够正常访问到pod，endpoint是否工作正常；</li></ol><p><em>ServiceMonitor 是否被 Prometheus 筛选到？</em></p><p>查看 <a target="_blank" rel="noopener" href="http://prome.minei.test/config">配置</a> 中是否有你配置的 job。</p><h3 id="Push-Metrics"><a href="#Push-Metrics" class="headerlink" title="Push Metrics"></a>Push Metrics</h3><p><code>Pushgateway</code> 允许临时和批量任务向prometheus推送 metric 数据。</p><h4 id="When-to-use-pushgateway"><a href="#When-to-use-pushgateway" class="headerlink" title="When to use pushgateway"></a><a target="_blank" rel="noopener" href="https://prometheus.io/docs/practices/pushing/">When to use pushgateway</a></h4><ul><li>捕获服务级别的批量任务处理结果，比如获取批量删除一大批的用户的结果；</li></ul><p>使用 <code>Pushgateway</code> 的缺陷：</p><ul><li>容易单点故障，可能会成为瓶颈；</li><li>没有Prometheus示例健康检查；</li><li>永远不会删除收到的数据，一直暴露给 Prometheus ，除非手动调用api删除。而正常的拉方式当实例消失的时候会自动删除 metric数据；</li></ul><p><strong>备选方案</strong></p><p>如果是防火墙或者是NAT导致prometheus无法拉取数据，可以使用 <a target="_blank" rel="noopener" href="https://github.com/RobustPerception/PushProx">PushProx</a> 让 Prometheus穿透NAT或者防火墙，正常的拉取数据。</p><h4 id="Deploy-Pushgateway-Push-metrics"><a href="#Deploy-Pushgateway-Push-metrics" class="headerlink" title="Deploy Pushgateway &amp; Push metrics"></a>Deploy Pushgateway &amp; Push metrics</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prome-push-gateway</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prome-push-gateway</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">prome-push-gateway</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">prome-push-gateway</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">prom/pushgateway:v1.4.2</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">prome-push-gateway</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9091</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">less-svc_hazelcast_kubernetes_namespace</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;product&quot;</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># pod service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prome-push-gateway</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prome-push-gateway</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">prome-push-gateway</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">push</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9091</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9091</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># ingress</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prome-push-gateway-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">annotations:</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">http:</span><br>        <span class="hljs-attr">paths:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">backend:</span><br>              <span class="hljs-attr">serviceName:</span> <span class="hljs-string">prome-push-gateway</span><br>              <span class="hljs-attr">servicePort:</span> <span class="hljs-string">push</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-string">pushgateway.minei.test</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">push-gateway</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">endpoints:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-string">push</span><br>    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span><br>    <span class="hljs-attr">scheme:</span> <span class="hljs-string">http</span><br>    <span class="hljs-comment"># pushgateway 的 monitor需要将该配置设置为 true，否则 job 将会被 exported_job 替代</span><br>    <span class="hljs-comment"># 同样 instance 也会被 exported_instance 替代</span><br>    <span class="hljs-attr">honorLabels:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">prome-push-gateway</span><br>  <span class="hljs-attr">namespaceSelector:</span><br>    <span class="hljs-attr">matchNames:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">monitoring</span><br></code></pre></td></tr></table></figure><p>大部分exporters都不支持pushgateway，所以需要自己push metric数据。</p><p>Pushgateway 支持类似 restful 的metric api，同时也支持admin api。</p><p>push一个metric数据（注意所有的换行都是 <code>\n</code> ，结尾也需要一个 <code>\n</code> 可以参考官方的客户端数据格式说明：<br><a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1ZjyKiKxZV83VI9ZKAXRGKaUKK2BIWCT7oiGBKDBpjEY">Prometheus Client Data Exposition Format</a> ）：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># TYPE test_metric counter</span><br><span class="hljs-attribute">test_metric</span>&#123;label=<span class="hljs-string">&quot;val1&quot;</span>&#125; <span class="hljs-number">42</span><br><span class="hljs-comment"># TYPE another_metric gauge</span><br><span class="hljs-comment"># HELP another_metric Just an example.</span><br><span class="hljs-attribute">another_metric</span> <span class="hljs-number">2398</span>.<span class="hljs-number">283</span><br><br></code></pre></td></tr></table></figure><p>查询metric：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">curl http:<span class="hljs-regexp">//</span>pushgateway.minei.test<span class="hljs-regexp">/api/</span>v1/metrics<br></code></pre></td></tr></table></figure><p>Pushgateway在 <code>/metrics</code> 暴露了所有的metrics数据，所以metric定义一定不能出现冲突，比如相同名称的metric必须有相同的类型和标签，如果冲突了push数据的时候会返回400。</p><p><strong><em><a target="_blank" rel="noopener" href="https://github.com/prometheus/client_java">Java Client</a></em></strong></p><h3 id="DataStorage"><a href="#DataStorage" class="headerlink" title="DataStorage"></a>DataStorage</h3><p>Prometheus支持本地存储和远程存储系统。</p><p>容器中默认的数据存储结构：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">./prometheus<br>├── <span class="hljs-number">01</span>BKGV7JBM69T2G1BGBGM6KB12<br>│   └── meta.json<br>├── <span class="hljs-number">01</span>BKGTZQ1SYQJTR4PB43C8PD98<br>│   ├── chunks<br>│   │   └── <span class="hljs-number">000001</span><br>│   ├── tombstones<br>│   ├── <span class="hljs-keyword">index</span><br>│   └── meta.json<br>├── <span class="hljs-number">01</span>BKGTZQ1HHWHV8FBJXW1Y3W0K<br>│   └── meta.json<br>├── <span class="hljs-number">01</span>BKGV7JC0RY8A6MACW02A2PJD<br>│   ├── chunks<br>│   │   └── <span class="hljs-number">000001</span><br>│   ├── tombstones<br>│   ├── <span class="hljs-keyword">index</span><br>│   └── meta.json<br>├── chunks_head<br>│   └── <span class="hljs-number">000001</span><br>└── wal<br>    ├── <span class="hljs-number">000000002</span><br>    └── <span class="hljs-keyword">checkpoint</span><span class="hljs-number">.00000001</span><br>        └── <span class="hljs-number">00000000</span><br></code></pre></td></tr></table></figure><ul><li>数据按照2h分为一组(block)；<ul><li><code>chunks</code> 文件夹里存储的是实际时序数据，默认512m为一个文件进行存储( <code>segment</code> )；</li><li>通过api删除的数据存储在 <code>tombstones</code>；</li><li>metadata；</li><li>index索引文件，索引的是chunks文件夹里metric名称和标签；</li></ul></li><li>当前采集到的数据是在内存中，并未完全持久化到文件，使用 <code>WAL</code> (wirte-ahead log) 加密存储在 wal 文件夹中，即使服务崩溃或者重启也能恢复内存中的数据；<ul><li>wal 中 128m 为一个文件，并且尚未经过压缩，</li></ul></li></ul><h4 id="存储配置"><a href="#存储配置" class="headerlink" title="存储配置"></a>存储配置</h4><ul><li>数据保留时间，operator配置在 <code>Prometheus.spec.retention</code> 下，默认24h；</li><li>block占用空间大小，operator配置在 <code>Prometheus.spec.retentionSize</code> 下；</li><li>wal压缩，operator配置在 <code>Prometheus.spec.walCompression</code> 下，稍微占用cpu；</li></ul><p>如果保留时间和大小同时配置了，哪个先触发就先使用哪个，过期的Block清理发生在后台。同时，Block只有在完全过期了才会被移除。</p><p>Prometheus每个数据平均占用空间为 1-2 bytes，可以用下面的公式来粗略计算存储占用：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">needed_disk_space</span> = retention_time_seconds * ingested_samples_per_second * bytes_per_sample<br></code></pre></td></tr></table></figure><p>数据抓取频率可以在servicemonitor中进行配置：<code>ServiceMonitor.spec.endpoints.interval</code>。</p><blockquote><p>If your local storage becomes corrupted for whatever reason, the best strategy to address the problem is to shut down Prometheus then remove the entire storage directory. You can also try removing individual block directories, or the WAL directory to resolve the problem. Note that this means losing approximately two hours data per block directory. Again, Prometheus’s local storage is not intended to be durable long-term storage; external solutions offer extended retention and data durability.</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Prometheus</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">prometheus:</span> <span class="hljs-string">k8s</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">k8s</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">alerting:</span><br>    <span class="hljs-attr">alertmanagers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-main</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/prometheus/prometheus:v2.22.1</span><br>  <span class="hljs-attr">nodeSelector:</span><br>    <span class="hljs-attr">kubernetes.io/os:</span> <span class="hljs-string">linux</span><br>  <span class="hljs-attr">podMonitorNamespaceSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">podMonitorSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">probeNamespaceSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">probeSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">memory:</span> <span class="hljs-string">400Mi</span><br>  <span class="hljs-attr">ruleSelector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">prometheus:</span> <span class="hljs-string">k8s</span><br>      <span class="hljs-attr">role:</span> <span class="hljs-string">alert-rules</span><br>  <span class="hljs-attr">securityContext:</span><br>    <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">2000</span><br>    <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">prometheus-k8s</span><br>  <span class="hljs-attr">serviceMonitorNamespaceSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">serviceMonitorSelector:</span> &#123;&#125;<br>  <span class="hljs-attr">version:</span> <span class="hljs-string">v2.22.1</span><br>  <span class="hljs-comment"># 数据保留时间和最大存储配置</span><br>  <span class="hljs-attr">retention:</span> <span class="hljs-string">30d</span><br>  <span class="hljs-attr">retentionSize:</span> <span class="hljs-string">1GB</span><br>  <span class="hljs-attr">storage:</span><br>  <span class="hljs-comment"># 存储配置</span><br>    <span class="hljs-attr">volumeClaimTemplate:</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">nfs-storage</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">1Gi</span><br>        <span class="hljs-attr">accessModes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span><br></code></pre></td></tr></table></figure><h4 id="Pushgateway-Storage"><a href="#Pushgateway-Storage" class="headerlink" title="Pushgateway Storage"></a>Pushgateway Storage</h4><p>Pushgateway默认不持久化数据，可以使用 <code>--persistence.file</code> 来配置持久化的文件。</p><h4 id="Remote-Storage"><a href="#Remote-Storage" class="headerlink" title="Remote Storage"></a>Remote Storage</h4><ul><li>remote write，配置位于 <code>Prometheus.spec.remoteRead</code></li><li>remote read，配置位于 <code>Prometheus.spec.remoteRead</code><ul><li>远程读取只读取了原始数据和标签，所有的操作还是在Prometheus服务器进行的。</li></ul></li><li>receive from other Prometheus server，内置receiver通过 <code>--enable-feature=remote-write-receiver</code> 来开启，路径是：<code>/api/v1/write</code></li></ul><p><a target="_blank" rel="noopener" href="https://prometheus.io/docs/operating/integrations/#remote-endpoints-and-storage">Remote Storage List</a></p><h3 id="AlertManager"><a href="#AlertManager" class="headerlink" title="AlertManager"></a>AlertManager</h3><p>配置告警和通知流程：</p><ol><li>配置和部署 Alertmanager；</li><li>Configure Prometheus to talk to the Alertmanager 在Prometheus中配置 Alertmanager；</li><li>Prometheus中配置规则；</li></ol><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">              <span class="hljs-built_in">load</span> alertmanager<br> Prometheus  <span class="hljs-comment">-------------------&gt;  Alertmanager</span><br>     ↓            alerting              ↓<br>     ↓                                  ↓<br>PrometheusRule                   AlertmanagerConfig<br></code></pre></td></tr></table></figure><p>Alertmanager配置包含3部分：</p><ul><li>抑制(Inhibition)规则：在与另一组匹配器匹配的告警存在的情况下使另一组匹配器告警规则失效的规则，两组匹配器必须要有一组相同的标签；</li><li>通知接收者(receivers)配置；</li><li>通知路由(<a target="_blank" rel="noopener" href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#route">route</a>)配置；</li></ul><p>receivers支持多种通知方式，email、webhook、wechat等等。<br>Alertmanager通过 <code>Alertmanager.spec.alertmanagerConfigNamespaceSelector</code> <code>Alertmanager.spec.alertmanagerConfigSelector</code> 来筛选配置。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">AlertmanagerConfig</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">alertmanager-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">alertmanagerConfig:</span> <span class="hljs-string">test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">route:</span><br>    <span class="hljs-attr">groupBy:</span> [<span class="hljs-string">&#x27;instance&#x27;</span>]<br>    <span class="hljs-attr">groupWait:</span> <span class="hljs-string">30s</span><br>    <span class="hljs-attr">groupInterval:</span> <span class="hljs-string">5m</span><br>    <span class="hljs-attr">repeatInterval:</span> <span class="hljs-string">12h</span><br>    <span class="hljs-attr">receiver:</span> <span class="hljs-string">&#x27;pushover&#x27;</span><br>    <span class="hljs-attr">matchers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span><br>      <span class="hljs-attr">value:</span> <span class="hljs-string">less-svc</span><br>  <span class="hljs-attr">receivers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;pushover&#x27;</span><br>    <span class="hljs-attr">pushoverConfigs:</span><br>      <span class="hljs-attr">userKey:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">pushover-userkey</span><br>        <span class="hljs-attr">key:</span> <span class="hljs-string">userkey</span><br>      <span class="hljs-attr">title:</span> <span class="hljs-string">Alert</span><br>      <span class="hljs-attr">token:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">pushover-userkey</span><br>        <span class="hljs-attr">key:</span> <span class="hljs-string">token</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pushover-userkey</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">userkey:</span> <span class="hljs-string">xxx</span><br>  <span class="hljs-attr">token:</span> <span class="hljs-string">xxx</span><br></code></pre></td></tr></table></figure><p>配置Alertmanager：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Alertmanager</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">alertmanager:</span> <span class="hljs-string">main</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">main</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br><span class="hljs-attr">spec:</span><br><span class="hljs-comment"># 一定要配置，否则无法正确加载到配置</span><br>  <span class="hljs-attr">alertmanagerConfigSelector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">alertmanagerConfig:</span> <span class="hljs-string">test</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/prometheus/alertmanager:v0.21.0</span><br>  <span class="hljs-attr">nodeSelector:</span><br>    <span class="hljs-attr">kubernetes.io/os:</span> <span class="hljs-string">linux</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">securityContext:</span><br>    <span class="hljs-attr">fsGroup:</span> <span class="hljs-number">2000</span><br>    <span class="hljs-attr">runAsNonRoot:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">1000</span><br>  <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">alertmanager-main</span><br>  <span class="hljs-attr">version:</span> <span class="hljs-string">v0.21.0</span><br></code></pre></td></tr></table></figure><p>Prometheus 通过 <code>Prometheus.spec.alerting</code> 来配置alertmanager，通过 <code>Prometheus.spec.ruleNamespaceSelector</code> 和 <code>Prometheus.spec.ruleSelector</code> 来配置rule。</p><h4 id="Prometheus-Rules"><a href="#Prometheus-Rules" class="headerlink" title="Prometheus Rules"></a>Prometheus Rules</h4><p>Prometheus 包含两种规则，一种是 RecordingRules, 一种是 AlertingRules。</p><p><strong><em>RecordingRules</em></strong></p><p>记录规则提供了 提前计算经常需要用的数据 或者 计算量大 的表达式，并且把计算结果保存到新的时序数据中，常见的就是一些复杂的监控面板数据。</p><p><strong><em>AlertingRules</em></strong></p><p>通过Prome表达式来定义报警条件，同时发送通知。</p><p><code>PrometheusRule.spec.groups.rules</code>：</p><table><thead><tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th><th>For</th></tr></thead><tbody><tr><td>record</td><td>record rules metric name</td><td>string</td><td>false</td><td>Recording</td></tr><tr><td>alert</td><td>alerting rules name</td><td>string</td><td>false</td><td>Alerting</td></tr><tr><td>expr</td><td>表达式</td><td>intstr.IntOrString</td><td>true</td><td>Both</td></tr><tr><td>for</td><td>触发表达式后告警前等待时间</td><td>string</td><td>false</td><td>Alerting</td></tr><tr><td>labels</td><td>标签，覆盖方式添加到metric或者alert</td><td>map[string]string</td><td>false</td><td>Both</td></tr><tr><td>annotations</td><td>添加到alert</td><td>map[string]string</td><td>false</td><td>Alerting</td></tr></tbody></table><p><strong><em>Templates</em></strong></p><p>告警中使用的模板基于 <a target="_blank" rel="noopener" href="https://golang.org/pkg/text/template">Go templating</a>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PrometheusRule</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus-alert-rules</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">monitoring</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">prometheus:</span> <span class="hljs-string">k8s</span><br>    <span class="hljs-attr">role:</span> <span class="hljs-string">alert-rules</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">groups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test.rules</span><br>    <span class="hljs-attr">rules:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">TestAppOffline</span><br>      <span class="hljs-attr">expr:</span> <span class="hljs-string">count</span> <span class="hljs-string">without()</span> <span class="hljs-string">(up&#123;endpoint=&quot;jmx&quot;,</span> <span class="hljs-string">job=&quot;less-svc&quot;&#125;)</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span><br>      <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">less-svc</span><br>      <span class="hljs-attr">annotations:</span><br>      <span class="hljs-comment"># 注意如果模板中需要使用标签，那么表达式最终结果也是需要带上这些标签的</span><br>        <span class="hljs-attr">description:</span> <span class="hljs-string">app</span> &#123;&#123; <span class="hljs-string">$labels.job</span> &#125;&#125; <span class="hljs-string">offline,</span> <span class="hljs-string">instance</span> &#123;&#123; <span class="hljs-string">$labels.instance</span> &#125;&#125;<br></code></pre></td></tr></table></figure><h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><h4 id="Exporters-Pushgateway"><a href="#Exporters-Pushgateway" class="headerlink" title="Exporters &amp; Pushgateway"></a>Exporters &amp; Pushgateway</h4><p>官方exporters和pushgateway支持tls和basic authentication，可以通过启动参数指定配置 <code>--web.config.file=&quot;web-config.yml&quot;</code>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tls_server_config:</span><br>  <span class="hljs-comment"># Certificate and key files for server to use to authenticate to client.</span><br>  <span class="hljs-attr">cert_file:</span> <span class="hljs-string">&lt;filename&gt;</span><br>  <span class="hljs-attr">key_file:</span> <span class="hljs-string">&lt;filename&gt;</span><br><br>  <span class="hljs-comment"># Server policy for client authentication. Maps to ClientAuth Policies.</span><br>  <span class="hljs-comment"># For more detail on clientAuth options: [ClientAuthType](https://golang.org/pkg/crypto/tls/#ClientAuthType)</span><br>  [ <span class="hljs-attr">client_auth_type:</span> <span class="hljs-string">&lt;string&gt;</span> <span class="hljs-string">|</span> <span class="hljs-string">default</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;NoClientCert&quot;</span> ]<br><br>  <span class="hljs-comment"># CA certificate for client certificate authentication to the server.</span><br>  [ <span class="hljs-attr">client_ca_file:</span> <span class="hljs-string">&lt;filename&gt;</span> ]<br><br>  <span class="hljs-comment"># Minimum TLS version that is acceptable.</span><br>  [ <span class="hljs-attr">min_version:</span> <span class="hljs-string">&lt;string&gt;</span> <span class="hljs-string">|</span> <span class="hljs-string">default</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;TLS12&quot;</span> ]<br><br>  <span class="hljs-comment"># Maximum TLS version that is acceptable.</span><br>  [ <span class="hljs-attr">max_version:</span> <span class="hljs-string">&lt;string&gt;</span> <span class="hljs-string">|</span> <span class="hljs-string">default</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;TLS13&quot;</span> ]<br><br>  <span class="hljs-comment"># List of supported cipher suites for TLS versions up to TLS 1.2. If empty,</span><br>  <span class="hljs-comment"># Go default cipher suites are used. Available cipher suites are documented</span><br>  <span class="hljs-comment"># in the go documentation:</span><br>  <span class="hljs-comment"># https://golang.org/pkg/crypto/tls/#pkg-constants</span><br>  [ <span class="hljs-attr">cipher_suites:</span><br>    [ <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;string&gt;</span> ] ]<br><br>  <span class="hljs-comment"># prefer_server_cipher_suites controls whether the server selects the</span><br>  <span class="hljs-comment"># client&#x27;s most preferred ciphersuite, or the server&#x27;s most preferred</span><br>  <span class="hljs-comment"># ciphersuite. If true then the server&#x27;s preference, as expressed in</span><br>  <span class="hljs-comment"># the order of elements in cipher_suites, is used.</span><br>  [ <span class="hljs-attr">prefer_server_cipher_suites:</span> <span class="hljs-string">&lt;bool&gt;</span> <span class="hljs-string">|</span> <span class="hljs-string">default</span> <span class="hljs-string">=</span> <span class="hljs-literal">true</span> ]<br><br>  <span class="hljs-comment"># Elliptic curves that will be used in an ECDHE handshake, in preference</span><br>  <span class="hljs-comment"># order. Available curves are documented in the go documentation:</span><br>  <span class="hljs-comment"># https://golang.org/pkg/crypto/tls/#CurveID</span><br>  [ <span class="hljs-attr">curve_preferences:</span><br>    [ <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;string&gt;</span> ] ]<br><br><span class="hljs-attr">http_server_config:</span><br>  <span class="hljs-comment"># Enable HTTP/2 support. Note that HTTP/2 is only supported with TLS.</span><br>  <span class="hljs-comment"># This can not be changed on the fly.</span><br>  [ <span class="hljs-attr">http2:</span> <span class="hljs-string">&lt;bool&gt;</span> <span class="hljs-string">|</span> <span class="hljs-string">default</span> <span class="hljs-string">=</span> <span class="hljs-literal">true</span> ]<br><br><span class="hljs-comment"># Usernames and hashed passwords that have full access to the web</span><br><span class="hljs-comment"># server via basic authentication. If empty, no basic authentication is</span><br><span class="hljs-comment"># required. Passwords are hashed with bcrypt.</span><br><span class="hljs-attr">basic_auth_users:</span><br>  [ <span class="hljs-string">&lt;string&gt;:</span> <span class="hljs-string">&lt;secret&gt;</span> <span class="hljs-string">...</span> ]<br></code></pre></td></tr></table></figure><p>同时在servicemonitor中 <code>servicemonitor.spec.endpoints.tlsConfig</code> 配置抓取的tls信息，<code>servicemonitor.spec.endpoints.basicAuth</code> 配置basic authentication。</p><h4 id="API-Security"><a href="#API-Security" class="headerlink" title="API Security"></a>API Security</h4><p>管理相关的API旨在使用简单的cURL工具访问，所以并没有做CSRF保护。在向外部不可信用户暴露的时候可以使用反向代理来避免CSRF，<br>对一些不信任的输入进行进行转义。</p><h4 id="Pushgateway"><a href="#Pushgateway" class="headerlink" title="Pushgateway"></a>Pushgateway</h4><p>由于一般都开启了 <code>honor_labels</code> ，所以能够访问到Pushgateway的用户都能创建任意的时间序列。<br>如果开启了 <code>--web.enable-admin-api</code> 则可以通过admin api操作任意的数据。</p><h3 id="Best-Practices"><a href="#Best-Practices" class="headerlink" title="Best Practices"></a>Best Practices</h3><h4 id="Naming"><a href="#Naming" class="headerlink" title="Naming"></a>Naming</h4><p>指标命名：</p><ul><li>符合模型 <a target="_blank" rel="noopener" href="https://prometheus.io/docs/concepts/data_model/#metric-names-and-labels">定义</a></li><li>有一个单词前缀，这个单词可以是应用名称、ns、也可以是某一类通用标准指标，比如：<code>prometheus_api_remote_read_queries</code> <code>process_cpu_seconds_total</code> <code>http_request_duration_seconds</code></li><li>必须有一个复数单位作为后缀，或者是 total 后缀作为计数：<code>http_request_duration_seconds</code> <code>node_memory_usage_bytes</code> <code>http_requests_total</code> <code>foobar_build_info</code></li><li>应该代表在所有标签维度上测量的相同逻辑事物</li></ul><p>使用标签来区分被观测事物的特征：</p><ul><li><code>node_cpu_seconds_total</code> 区分不同状态：idle,iowait,irq,nice,softirq,steal,system,user</li><li><code>http_request_duration_milliseconds</code> 区分不同的状态码：200,302等</li><li>不能使用标签来存储无限制的值集合，比如用户id，邮箱等等</li></ul><p>基础单位：</p><table><thead><tr><th>Family</th><th>Base unit</th><th>Remark</th></tr></thead><tbody><tr><td>Time</td><td>seconds</td><td></td></tr><tr><td>Temperature</td><td>celsius</td><td>celsius is preferred over kelvin for practical reasons. kelvin is acceptable as a base unit in special cases like color temperature or where temperature has to be absolute.</td></tr><tr><td>Length</td><td>meters</td><td></td></tr><tr><td>Bytes</td><td>bytes</td><td></td></tr><tr><td>Bits</td><td>bytes</td><td>To avoid confusion combining different metrics, always use bytes, even where bits appear more common.</td></tr><tr><td>Percent</td><td>ratio</td><td>Values are 0–1 (rather than 0–100). ratio is only used as a suffix for names like disk_usage_ratio. The usual metric name follows the pattern A_per_B.</td></tr><tr><td>Voltage</td><td>volts</td><td></td></tr><tr><td>Electric current</td><td>amperes</td><td></td></tr><tr><td>Energy</td><td>joules</td><td></td></tr><tr><td>Power</td><td></td><td>Prefer exporting a counter of joules, then rate(joules[5m]) gives you power in Watts.</td></tr><tr><td>Mass</td><td>grams</td><td>grams is preferred over kilograms to avoid issues with the kilo prefix.</td></tr></tbody></table><h4 id="Recording-rules"><a href="#Recording-rules" class="headerlink" title="Recording rules"></a>Recording rules</h4><p>复合 <code>level:metric:operations</code> 的命名规则：</p><ul><li>level代表聚合级别和标签</li><li>metric代表指标名称，除了使用 <code>rate()</code> 和 <code>irate()</code> 的时候应该保持不变</li><li>operations代表的是操作列表，使用最新的操作</li></ul><h4 id="HISTOGRAMS-AND-SUMMARIES"><a href="#HISTOGRAMS-AND-SUMMARIES" class="headerlink" title="HISTOGRAMS AND SUMMARIES"></a>HISTOGRAMS AND SUMMARIES</h4><table><thead><tr><th>&#x2F;</th><th>Histogram</th><th>Summary</th></tr></thead><tbody><tr><td>配置</td><td>选择适合观察值的预期范围的bucket</td><td>选择所需的 φ 分位数和滑动窗口。 其他未选择的 φ 分位数和滑动窗口无法稍后计算。</td></tr><tr><td>客户端性能</td><td>由于只需要counters，所以不怎么消耗性能</td><td>计算流分位数非常消耗性能</td></tr><tr><td>服务器性能</td><td>需要服务器来计算q分位数，很消耗性能，但是可以使用recording rules来预计算</td><td>性能消耗小</td></tr><tr><td>时间序列数量 (除了 _sum 和 _count 序列)</td><td>每一个bucket都有一个序列</td><td>每一个配置的分位数都有一个序列</td></tr><tr><td>分位数误差 (see below for details)</td><td>选择合适的buckets</td><td>Error is limited in the dimension of φ by a configurable value.</td></tr><tr><td>φ分位数和滑动窗口定义</td><td>通过PromeQL定义</td><td>通过客户端定义</td></tr><tr><td>聚合</td><td>可通过PromeQL聚合</td><td>一般不可聚合</td></tr><tr><td>查询方式</td><td><code>histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))</code></td><td><code>http_request_duration_seconds_summary&#123;quantile=&quot;0.95&quot;&#125;</code></td></tr></tbody></table><p><code>histogram_quantile</code> 采用线性插值：<br><img src="https://user-images.githubusercontent.com/2216970/70043870-3a2a1600-15fc-11ea-92a1-c3cbdcbaa785.png"></p><p>计算方式：<code>分位值=起始bucket大小+(本bucket宽度)*(目标分位数在本bucket排行/本bucket记录数)</code></p><p>如果bucket选择合适，那么得到的分位数误差就较小。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;0.05&quot;</span>&#125; <span class="hljs-number">199881</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;0.1&quot;</span>&#125; <span class="hljs-number">212210</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;0.2&quot;</span>&#125; <span class="hljs-number">215395</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;0.4&quot;</span>&#125; <span class="hljs-number">319435</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;0.8&quot;</span>&#125; <span class="hljs-number">419576</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;1.6&quot;</span>&#125; <span class="hljs-number">469593</span><br><span class="hljs-attribute">prometheus_http_request_duration_seconds_bucket</span>&#123;le=<span class="hljs-string">&quot;+Inf&quot;</span>&#125; <span class="hljs-number">519593</span><br><span class="hljs-comment"># 计算0.75分位数</span><br><span class="hljs-attribute">0</span>.<span class="hljs-number">75</span> * <span class="hljs-number">519593</span> = <span class="hljs-number">389694</span>.<span class="hljs-number">75</span> 位于 <span class="hljs-number">0</span>.<span class="hljs-number">4</span>~<span class="hljs-number">0</span>.<span class="hljs-number">8</span>之间<br><span class="hljs-attribute">0</span>.<span class="hljs-number">4</span> + (<span class="hljs-number">0</span>.<span class="hljs-number">8</span>-<span class="hljs-number">0</span>.<span class="hljs-number">4</span>) * ((<span class="hljs-number">389694</span>.<span class="hljs-number">75</span> - <span class="hljs-number">319435</span>) / (<span class="hljs-number">419576</span> - <span class="hljs-number">319435</span>))<br></code></pre></td></tr></table></figure><p><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/92f416a6f45dd28ad7711e745b66d8c747817855"></p><p>如何选择：</p><ul><li>需要聚合选择 <code>Histogram</code></li><li>如果了解观测值的分布那么选择 <code>Histogram</code>；如果需要准确的分位数选择 <code>Summary</code></li></ul><h2 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h2><h3 id="Datasource"><a href="#Datasource" class="headerlink" title="Datasource"></a>Datasource</h3><p>支持多种数据源，通过kube-prometheus安装的时候已经集成了Prometheus数据源。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs tap">-rw-r--r--.<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 550 </span>Oct<span class="hljs-number"> 27 </span>10:37 grafana-dashboardDatasources.yaml  <span class="hljs-comment"># 配置数据源</span><br>-rw-r--r--.<span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1403539 </span>Oct<span class="hljs-number"> 27 </span>10:37 grafana-dashboardDefinitions.yaml  <span class="hljs-comment"># 配置面板</span><br>-rw-r--r--.<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 454 </span>Oct<span class="hljs-number"> 27 </span>10:37 grafana-dashboardSources.yaml<br>-rw-r--r--.<span class="hljs-number"> 1 </span>root root   <span class="hljs-number"> 7629 </span>Oct<span class="hljs-number"> 27 </span>10:37 grafana-deployment.yaml<br>-rw-r--r--.<span class="hljs-number"> 1 </span>root root     <span class="hljs-number"> 86 </span>Oct<span class="hljs-number"> 27 </span>10:37 grafana-serviceAccount.yaml<br>-rw-r--r--.<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 208 </span>Oct<span class="hljs-number"> 27 </span>10:37 grafana-serviceMonitor.yaml<br>-rw-r--r--.<span class="hljs-number"> 1 </span>root root    <span class="hljs-number"> 201 </span>Oct<span class="hljs-number"> 27 </span>10:37 grafana-service.yaml<br></code></pre></td></tr></table></figure><h3 id="Dashboards"><a href="#Dashboards" class="headerlink" title="Dashboards"></a>Dashboards</h3><p>支持json导入，手动配置，配置文件配置，<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards">官方面板应用商城</a> id导入。</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">Default<br>├── DashBoard<br>│   ├── panel1<br>│   │   └── query<br>|<span class="hljs-string">   </span>|<span class="hljs-string">   └── alert</span><br><span class="hljs-string">│   ├── panel2</span><br><span class="hljs-string">│   │   └── query</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   └── alert</span><br><span class="hljs-string">General</span><br><span class="hljs-string">│   ├── panel3</span><br><span class="hljs-string">│   │   └── query</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   └── alert</span><br><span class="hljs-string">│   ├── panel4</span><br><span class="hljs-string">│   │   └── query</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">   └── alert</span><br></code></pre></td></tr></table></figure><h3 id="Alert"><a href="#Alert" class="headerlink" title="Alert"></a>Alert</h3><p>告警配置跟随面板一起配置的：</p><ul><li>触发频率；</li><li>触发条件；</li><li>没有数据或者出现异常如何处理；</li><li>通知内容和标签设置；</li><li>设置receiver；</li></ul><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/cloud-native-logging-notes">Cloud Native Logging Notes </a></span><span class="next"><a href="/posts/26">大理 - 洱海</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>