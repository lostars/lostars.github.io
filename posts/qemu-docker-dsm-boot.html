<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>qemu-docker 引导黑群晖 - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>qemu-docker 引导黑群晖</h1><div><time>2024-06-24</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/mess/">mess</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/qemu-docker/">qemu-docker</a></span></div></div></header><h2 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h2><p>为了获取dva系列<code>SurveillanceStation</code>自带的8许可证，主机环境：<code>DSM918+ 7.2.1-69057 Update 4</code>，群晖内部存储空间全部都是<code>ext4</code>格式，没法使用自带的<code>VMM</code>。<br>qemu-docker来自于项目： <a target="_blank" rel="noopener" href="https://github.com/qemus/qemu-docker">https://github.com/qemus/qemu-docker</a><br>类似的项目： <a target="_blank" rel="noopener" href="https://github.com/vdsm/virtual-dsm">https://github.com/vdsm/virtual-dsm</a><br>上面两个项目都是基于<code>Debian</code>，本质是一样的，第二个项目可以直接启动群晖的<code>pat</code>安装文件，这里不作展开。<br>引导镜像来自于：<a target="_blank" rel="noopener" href="https://github.com/fbelavenuto/arpl">fbelavenuto&#x2F;arpl</a>，目前该项目已被归档，追求更新或新dsm系统的可以使用：<a target="_blank" rel="noopener" href="https://github.com/RROrg/rr">RROrg&#x2F;rr</a>。这里使用的是前者，因为尝试了多次使用<code>RROrg/rr</code>的最新引导都会卡在启动界面，后续如果成功了会再更新。</p><h2 id="引导并安装DSM"><a href="#引导并安装DSM" class="headerlink" title="引导并安装DSM"></a>引导并安装DSM</h2><p>直接用<code>docker composer</code>进行部署：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">qemu-dsm:</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">qemu-dsm</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">qemux/qemu-docker:latest</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-attr">proxy:</span><br>    <span class="hljs-attr">devices:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/dev/kvm</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-comment"># 引导镜像映射为boot.img直接用于qemu启动</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/volume1/docker/qemu-dsm/arpl.img:/boot.img&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/volume1/docker/qemu-dsm:/storage&quot;</span><br>    <span class="hljs-attr">cap_add:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">NET_ADMIN</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-comment"># qemu的vnc端口</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">8006</span><span class="hljs-string">:8006</span><br>      <span class="hljs-comment"># 群晖的web安装端口</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">5001</span><span class="hljs-string">:5000</span><br>      <span class="hljs-comment"># 群晖的ssh端口，映射出来方便后续调试</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-number">5002</span><span class="hljs-string">:22</span><br>    <span class="hljs-attr">stop_grace_period:</span> <span class="hljs-string">2m</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-comment"># ARGUMENTS: &quot;-drive id=disk,format=raw,file=/storage/dsm.img&quot;</span><br>      <span class="hljs-attr">DISK_TYPE:</span> <span class="hljs-string">&quot;usb&quot;</span><br>      <span class="hljs-attr">DISK_SIZE:</span> <span class="hljs-string">&quot;4G&quot;</span><br>      <span class="hljs-attr">RAM_SIZE:</span> <span class="hljs-string">&quot;1G&quot;</span><br>      <span class="hljs-attr">CPU_CORES:</span> <span class="hljs-string">&quot;1&quot;</span><br>      <span class="hljs-attr">DEBUG:</span> <span class="hljs-string">&quot;Y&quot;</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">proxy:</span><br>    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>正常使用上面的引导进行应该都是通过烧录到U盘上然后插上主机进行引导的，但是这里的主机是通过docker启动的qemu镜像，所以配置qemu时候<code>DISK_TYPE</code>设置成了<code>usb</code>。<br>容器成功启动后会自动进入引导镜像配置加载器，查看qemu容器的网络配置（只截取了重要的部分）：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">3</span>: dockerbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state UP group default qlen <span class="hljs-number">1000</span><br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">52</span>:<span class="hljs-number">10</span>:c4:<span class="hljs-number">7</span>c:<span class="hljs-number">84</span>:<span class="hljs-number">12</span> brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">20.20.20.1</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">20.20.20.255</span> scope global dockerbridge<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br></code></pre></td></tr></table></figure><p>这个<code>dockerbridge</code>网络就是qemu给虚拟机建立的通信网络。<br>通过vnc查看引导界面：<br><img src="/../../images/blog/screenshot-1.png"><br>可以看到上面配置的磁盘被正确识别成了U盘，同时ip也获取到了，是使用的<code>dockerbridge</code>网络。<br>如果这个时候网络没有获取到正确的ip，引导会提示错误，找不到ip地址，这时需要手动进行配置ip，vnc中执行<code>ip addr</code>获取网络信息，使用<code>ipconfig</code>手动配置ip地址。注意这个修改重启就会消失，配置并安装好dsm之后需要手动配置dsm的ip。<br>网络配置完毕之后运行<code>menu.sh</code>进行引导编译，型号选择<code>DVA1622</code>，注意序列号要使用：<code>2260UBR457845</code>，否则<code>SurveillanceStation</code>许可证是无效的。序列号也完全被破译，可以参考：<a target="_blank" rel="noopener" href="https://www.openos.org/threads/sn.4469/">https://www.openos.org/threads/sn.4469/</a> 。<br>按照网上各种教程编译好加载器之后，选择<code>Advanced menu</code>-<code>Show SATA(S) # ports and drives</code>，发现是没有硬盘挂载上的。<br>此时进入qemu容器内创建空硬盘：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">qemu-img <span class="hljs-keyword">create</span> /<span class="hljs-keyword">storage</span>/dsm.img <span class="hljs-number">32</span>G<br></code></pre></td></tr></table></figure><p>配置docker compose，只需要在上面的配置中添加一个环境变量即可：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">ARGUMENTS:</span> <span class="hljs-string">&quot;-drive id=disk,format=raw,file=/storage/dsm.img&quot;</span><br></code></pre></td></tr></table></figure><p>重启容器，因为已经编译好了引导，正常就会直接进入安装dsm的流程了。如果手快选择配置加载器，进入上面提到的菜单，可以看到硬盘正确识别并挂载上了。<br>需要配置多个硬盘，重复上面流程，环境变量中id换下即可。<br>安装时需要注意，该引导应该只支持<code>7.1.1-42962</code>，不支持7.2系统，安装好之后成功升级到7.1.1最新系统。<br>系统安装好之后手动安装<code>SurveillanceStation</code>套件，在套件应用程序中心启动CMS，并配置为录制服务器模式。主机<code>SurveillanceStation</code>中CMS配置为主服务器模式，然后添加录制服务器配置虚拟机中的套件即可。验证成功之后可以在许可证中心看到许可证成功叠加。按理通过这种方式可以进行无限叠加，就是虚拟出来的dsm系统需要一直开着，这就是上面的qemu docker资源不需要分配太多的原因。</p><blockquote><p>注意</p></blockquote><p>安装成功之后上面的引导镜像是已经被修改过了。需要全新安装，可以选择一个新的镜像进行引导。</p><p>如果在引导镜像中无法下载群晖系统，可以设置代理：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-keyword">declare</span> -<span class="hljs-keyword">x</span> https_proxy<span class="hljs-operator">=</span><span class="hljs-string">&quot;http://ip:port/&quot;</span><br><span class="hljs-keyword">declare</span> -<span class="hljs-keyword">x</span> http_proxy<span class="hljs-operator">=</span><span class="hljs-string">&quot;http://ip:port/&quot;</span><br><span class="hljs-keyword">declare</span> -<span class="hljs-keyword">x</span> all_proxy<span class="hljs-operator">=</span><span class="hljs-string">&quot;socks5:://ip:port/&quot;</span><br></code></pre></td></tr></table></figure><p>如果配置了某些环境变量，需要qemu安装某些软件，可以设置apt代理（基于Debian）：</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-meta"># 创建文件，配置如下内容，然后将该文件映射到 /etc/apt/apt.conf.d/proxy.conf </span><br><span class="hljs-symbol">Acquire:</span>:http::Proxy <span class="hljs-string">&quot;http://ip:port/&quot;</span><span class="hljs-punctuation">;</span><br><span class="hljs-symbol">Acquire:</span>:https::Proxy <span class="hljs-string">&quot;http://ip:port/&quot;</span><span class="hljs-punctuation">;</span><br></code></pre></td></tr></table></figure><h3 id="硬解"><a href="#硬解" class="headerlink" title="硬解"></a>硬解</h3><p>尝试过将<code>/dev/dri</code>映射进qemu容器，也使用环境变量<code>GPU=Y</code>等方式开启，但是依旧失败，虚拟机内无法打开<code>/dev/dri</code>。<br>相关讨论：<br><a target="_blank" rel="noopener" href="https://github.com/vdsm/virtual-dsm/issues/720">https://github.com/vdsm/virtual-dsm/issues/720</a><br><a target="_blank" rel="noopener" href="https://github.com/vdsm/virtual-dsm/issues/234">https://github.com/vdsm/virtual-dsm/issues/234</a><br><a target="_blank" rel="noopener" href="https://github.com/vdsm/virtual-dsm/issues/334">https://github.com/vdsm/virtual-dsm/issues/334</a></p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>一晚之后发现虚拟机的<code>SurveillanceStation</code>无法打开，显示运行中且存储空间耗尽，从<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1dV4y1i7X7/">BV1dV4y1i7X7</a>评论中找到了解决方案。<br>清空<code>/volume1/@appstore/SurveillanceStation/local_display/.config/chromium-local-display/BrowserMetrics</code>文件夹，套件恢复正常，同时打开套件的应用中心停用<code>local display</code>。</p><p>装好DSM之后发现<code>/bin/gzip -l</code>这个命令偶发性的占用cpu，直接删除并备份该文件后恢复正常。上面的<code>local display</code>停用后再恢复该文件，也未出现<code>/bin/gzip</code>相关的高cpu占用。</p><h3 id="DSM重启之后无法找到kvm"><a href="#DSM重启之后无法找到kvm" class="headerlink" title="DSM重启之后无法找到kvm"></a>DSM重启之后无法找到kvm</h3><p>重启之后qemu报<code>/dev/kvm</code>找不到，手动安装<code>insmod /lib/modules/kvm.ko</code>，也会报错。只能通过安装vmm来正确加载kvm模块，就算没有<code>btrfs</code>存储空间也不影响。</p><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/install-debian-12.5-on-surface-book-2">Surface Book 2 安装 Debian 12.5 </a></span><span class="next"><a href="/posts/qbittorrent-search-plugin-debug">qbittorrent 搜索插件调试</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>