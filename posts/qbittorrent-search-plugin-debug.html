<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>qbittorrent 搜索插件调试 - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>qbittorrent 搜索插件调试</h1><div><time>2024-06-19</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/mess/">mess</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/qbittorrent/">qbittorrent</a> </span><span class="tag"><span class="category-separator">#</span> <a href="/tags/nas/">nas</a></span></div></div></header><h2 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h2><p>调试的插件：<a target="_blank" rel="noopener" href="https://github.com/TuckerWarlock/qbittorrent-search-plugins">bt4gprx</a> ，来自于 <a target="_blank" rel="noopener" href="https://github.com/qbittorrent/search-plugins/wiki/Unofficial-search-plugins">非官方插件目录</a><br>qbittorrent版本： docker latest 来自于 <a target="_blank" rel="noopener" href="https://hub.docker.com/r/superng6/qbittorrentee">qbittorrentee</a><br>该插件搜索没有任何输出，且qbittorrent日志目录无任何输出，官方仓库相关issue：<a target="_blank" rel="noopener" href="https://github.com/qbittorrent/qBittorrent/issues/20104">#20104</a></p><p>马后炮：<br><code>downloadtorrentfile.com</code>域名可以直连，部分机场代理是屏蔽torrent关键字的。<br>docker qbittorrent搜索插件调用的是webui中<code>选项-连接-代理服务器</code>配置的代理，docker环境变量中配置的代理是无法使用的。<br>qbitttorrent插件安装位置：<code>.../config/qBittorrent/data/nova3/engines</code> 。注意该文件夹下的插件都有缓存，并且在docker容器重启之后会还原所有改动，所以要修改最好停止容器后进行修改或者外部修改之后重新安装插件。<br>qbittorrent插件可用于调试的程序入口：<code>.../config/qBittorrent/data/nova3/nova2.py</code>。该入口可调试所有已安装插件，使用方法：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css"># 该调试方式会使用配置于环境变量的代理<br>nova2<span class="hljs-selector-class">.py</span> <span class="hljs-selector-attr">[engines]</span> <span class="hljs-selector-attr">[category]</span> <span class="hljs-selector-attr">[keywords]</span><br></code></pre></td></tr></table></figure><h2 id="debugging"><a href="#debugging" class="headerlink" title="debugging"></a>debugging</h2><p>从上面的issue中猜测没有搜索结果很有可能是网络问题，然后是插件本身问题，内部报错或者解析网站失败等等。<br>将qbittorrent配置文件夹<code>nova3</code>导入vscode直接进行本地调试。使用<code>launch.json</code>进行调试同时本地开启clash代理：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.2.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;configurations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Python Debugger: Current File&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debugpy&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;request&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;launch&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;program&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nova2.py&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;console&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integratedTerminal&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-comment">// nova2 调试参数</span><br>            <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;bt4gprx&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;all&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MEYD-909&quot;</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>发现无结果输出，分析<code>bt4gprx</code>插件结构：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">...<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">bt4gprx</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    url = <span class="hljs-string">&quot;https://bt4gprx.com/&quot;</span><br>    name = <span class="hljs-string">&quot;bt4gprx&quot;</span><br>    supported_categories = &#123;<span class="hljs-string">&#x27;all&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;movies&#x27;</span>: <span class="hljs-string">&#x27;movie/&#x27;</span>, <span class="hljs-string">&#x27;tv&#x27;</span>: <span class="hljs-string">&#x27;movie/&#x27;</span>, <span class="hljs-string">&#x27;music&#x27;</span>: <span class="hljs-string">&#x27;audio/&#x27;</span>, <span class="hljs-string">&#x27;books&#x27;</span>: <span class="hljs-string">&#x27;doc/&#x27;</span>, <span class="hljs-string">&#x27;software&#x27;</span>: <span class="hljs-string">&#x27;app/&#x27;</span>&#125;<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_init_</span>(<span class="hljs-params">self</span>):<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyHTMLParser</span>(<span class="hljs-title class_ inherited__">HTMLParser</span>):<br>    <span class="hljs-comment"># 搜索入口</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">self, term, cat=<span class="hljs-string">&quot;all&quot;</span></span>):<br>    <span class="hljs-comment"># 分页搜索，搜索入口调用</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search_page</span>(<span class="hljs-params">self, term, pagenumber, cat</span>):<br>    <span class="hljs-comment"># 解析磁力链接</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_torrent</span>(<span class="hljs-params">self, info</span>):<br>    <span class="hljs-comment"># 格式化返回符合qbit解析的数据</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pretty_print_results</span>(<span class="hljs-params">self, results</span>):<br></code></pre></td></tr></table></figure><p>进一步分析发现最终请求是调用的<code>retrieve_url</code>这个方法，该方法来自于<code>nova3/helpers.py</code>，查看部分源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Some sites blocks default python User-agent</span><br>user_agent = <span class="hljs-string">&#x27;Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0&#x27;</span><br>headers = &#123;<span class="hljs-string">&#x27;User-Agent&#x27;</span>: user_agent&#125;<br><span class="hljs-comment"># SOCKS5 Proxy support</span><br><span class="hljs-keyword">if</span> <span class="hljs-string">&quot;sock_proxy&quot;</span> <span class="hljs-keyword">in</span> os.environ <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(os.environ[<span class="hljs-string">&quot;sock_proxy&quot;</span>].strip()) &gt; <span class="hljs-number">0</span>:<br>    proxy_str = os.environ[<span class="hljs-string">&quot;sock_proxy&quot;</span>].strip()<br>    m = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&quot;^(?:(?P&lt;username&gt;[^:]+):(?P&lt;password&gt;[^@]+)@)?(?P&lt;host&gt;[^:]+):(?P&lt;port&gt;\w+)$&quot;</span>,<br>                 proxy_str)<br>    <span class="hljs-keyword">if</span> m <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, m.group(<span class="hljs-string">&#x27;host&#x27;</span>),<br>                              <span class="hljs-built_in">int</span>(m.group(<span class="hljs-string">&#x27;port&#x27;</span>)), <span class="hljs-literal">True</span>, m.group(<span class="hljs-string">&#x27;username&#x27;</span>), m.group(<span class="hljs-string">&#x27;password&#x27;</span>))<br>        socket.socket = socks.socksocket<br></code></pre></td></tr></table></figure><p>发现程序本身是从环境变量中获取了socks代理，且设置了ua，但是ua太过于陈旧，可见该文件估计有很多年没被人改动了。测试发现就算环境变量配置了<code>sock_proxy</code>依旧无法使用代理，不清楚py版本更替，qbit docker内置的py版本是<code>3.10.x</code>，猜测上面的调用方式在py3中可能不生效。<br>继续debug：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">search_page</span>(<span class="hljs-params">self, term, pagenumber, cat</span>):<br>    <span class="hljs-keyword">try</span>:<br>        query = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.url&#125;</span><span class="hljs-subst">&#123;self.supported_categories[cat]&#125;</span>search/<span class="hljs-subst">&#123;term&#125;</span>/byseeders/<span class="hljs-subst">&#123;pagenumber&#125;</span>&quot;</span><br>        parser = <span class="hljs-variable language_">self</span>.MyHTMLParser();<br>        res = retrieve_url(query)<br>        <span class="hljs-keyword">return</span> parser.feed(res)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> []<br></code></pre></td></tr></table></figure><p>发现此时<code>res</code>变量返回值异常：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">&#x27;<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span> /&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;a9d4a12ffef2772d8ade6b31-text/javascript&quot;</span>&gt;</span><span class="language-javascript">\ndocument.<span class="hljs-property">cookie</span> = <span class="hljs-string">&quot;ge_js_validator_22=1718790079@22@b954a468bd39a1650a0fe9debc7e1476; path=/; max-age=3600;&quot;</span>;\nwindow.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>();\n</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>\n<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>\n<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min.js&quot;</span> <span class="hljs-attr">data-cf-settings</span>=<span class="hljs-string">&quot;a9d4a12ffef2772d8ade6b31-|49&quot;</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>\n<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>&#x27;<br></code></pre></td></tr></table></figure><p>通过<code>ge_js_validator_22</code>和返回值异常可以猜测应该是触发了某种验证，但是本地开了代理且在debug过程中有请求日志产生，Chrome浏览器访问也是正常。那就应该是客户端差异导致的了，联想到上面异常老旧的ua，应该是网站反爬触发，先修改ua。<br>上面提到最终发请求的是<code>helpers</code>，为了不破坏原有代码结构，在自身插件中配置ua：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> helpers<br>    helpers.headers = &#123;<span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36&#x27;</span>&#125;<br></code></pre></td></tr></table></figure><p>再次debug，发现正常解析出结果，在qbittorrent docker webui中重新安装插件，发现还是无搜索结果，那就是代理的问题。发现在docker环境变量中配置代理不生效，只有通过qbit webui配置代理生效，能够正常搜索出结果。</p><blockquote><p>如果不想在qbittorrent中配置代理呢？</p></blockquote><p>只能通过修改插件代码了，上面提到所有的请求都是通过<code>helpers.retrieve_url</code>来发送的，为了不破坏代码结构，在当前插件重新定义发送请求方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">headers = &#123;<span class="hljs-string">&#x27;User-Agent&#x27;</span>: <span class="hljs-string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36&#x27;</span>&#125;<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_url</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">try</span>:<br>        http_proxy = os.environ[<span class="hljs-string">&quot;HTTP_PROXY&quot;</span>]<br>        https_proxy = os.environ[<span class="hljs-string">&quot;HTTPS_PROXY&quot;</span>]<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        http_proxy = <span class="hljs-literal">None</span><br>        https_proxy = <span class="hljs-literal">None</span><br>    req = urllib.request.Request(url, headers=headers)<br>    req = urllib.request.Request(url, headers=headers)<br>    <span class="hljs-keyword">if</span> http_proxy <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> https_proxy <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        proxies = &#123;<span class="hljs-string">&#x27;http&#x27;</span>: http_proxy, <span class="hljs-string">&#x27;https&#x27;</span>: https_proxy&#125;<br>        opener = urllib.request.build_opener(urllib.request.ProxyHandler(proxies))<br>        urllib.request.install_opener(opener)<br></code></pre></td></tr></table></figure><p>上面代码只贴出了核心改动，其他和<code>helpers.retrieve_url</code>一样。新的请求方法从环境变量中获取http代理，然后设置到请求上。vscode debug <code>launch.json</code>改动，添加了环境变量进行调试，本地clash设置不添加系统代理方便测试。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0.2.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;configurations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Python Debugger: Current File&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;debugpy&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;request&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;launch&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;program&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;nova2.py&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;console&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integratedTerminal&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;bt4gprx&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;all&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;MEYD-909&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;env&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;HTTP_PROXY&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost:7899&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;HTTPS_PROXY&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://localhost:7899&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>本地调试通过，docker qbit重新安装插件，取消webui中的代理，在docker compose中配置环境变量进行代理，重启容器，测试通过，搜索正常出结果。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>原本是使用Jackett来提供主要搜索的，但是发现Jackett并没有收录bt4g，搜索一圈发现官方已经放弃了支持：<a target="_blank" rel="noopener" href="https://github.com/Jackett/Jackett/issues/14624">issue</a>，这才有了上面的折腾过程。<br>回顾整个过程，因为不熟悉python，在怎么给py设置代理上花了大量时间，最后还是在官方文档中找到了线索：<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/urllib.request.html#proxyhandler-objects">ProxyHandler</a>，最后在stackoverflow上发现了答案：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3168171/how-can-i-open-a-website-with-urllib-via-proxy-in-python">how-can-i-open-a-website-with-urllib-via-proxy-in-python</a>。</p><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>使用发现经常出现搜索结果和网页不一致的情况，应该是超时导致的。再次分析插件代码，发现在搜索的时候插件就解析出了所有的磁力链接，那最终的请求次数就是：<code>结果数量 + 分页数量</code>。但是很明显搜索结果页面是不需要磁力链接的，磁力链接可以在qbit结果页面选择下载时进行解析，但这样就需要额外的后端服务来处理这个详情链接。</p><h3 id="修改返回结果列表url"><a href="#修改返回结果列表url" class="headerlink" title="修改返回结果列表url"></a>修改返回结果列表url</h3><p>最终的返回结果是在<code>pretty_print_results</code>中进行处理，做如下修改：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen_server</span>():<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 后端处理地址，依旧从环境变量中读取</span><br>        gen_server = os.environ[<span class="hljs-string">&quot;BT4GPRX_GEN_SERVER&quot;</span>]<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">if</span> gen_server <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">return</span> gen_server<br>      <span class="hljs-comment"># ......</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pretty_print_results</span>(<span class="hljs-params">self, results</span>):<br>        sorted_results = <span class="hljs-built_in">sorted</span>(results, key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">int</span>(x[<span class="hljs-string">&#x27;seeders&#x27;</span>]), reverse=<span class="hljs-literal">True</span>)<br>        gen_server_addr = gen_server()<br>        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> sorted_results:<br>            desc_link = urljoin(<span class="hljs-variable language_">self</span>.url, result[<span class="hljs-string">&#x27;href&#x27;</span>])<br>            <span class="hljs-keyword">if</span> gen_server_addr <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-comment"># 如果配置了后端链接则使用后端进行解析，参数为url</span><br>                magnet_link = gen_server_addr + <span class="hljs-string">&quot;?url=&quot;</span> + urllib.parse.quote_plus(desc_link)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># 否则还是进行解析</span><br>                magnet_link = <span class="hljs-variable language_">self</span>.download_torrent(desc_link)<br>            temp_result = &#123;<br>                <span class="hljs-string">&#x27;name&#x27;</span>: result[<span class="hljs-string">&#x27;title&#x27;</span>],<br>                <span class="hljs-string">&#x27;size&#x27;</span>: result[<span class="hljs-string">&#x27;filesize&#x27;</span>],<br>                <span class="hljs-string">&#x27;seeds&#x27;</span>: result[<span class="hljs-string">&#x27;seeders&#x27;</span>],<br>                <span class="hljs-string">&#x27;leech&#x27;</span>: result[<span class="hljs-string">&#x27;leechers&#x27;</span>],<br>                <span class="hljs-string">&#x27;engine_url&#x27;</span>: <span class="hljs-variable language_">self</span>.url,<br>                <span class="hljs-string">&#x27;link&#x27;</span>: magnet_link,<br>                <span class="hljs-comment"># 详情url，方便搜索页面右键跳转到站点，key值可以从插件目录中jackett的插件源码中获取到</span><br>                <span class="hljs-string">&#x27;desc_link&#x27;</span>: desc_link<br>            &#125;<br>            prettyPrinter(temp_result)<br></code></pre></td></tr></table></figure><h3 id="解析磁力链接后端服务"><a href="#解析磁力链接后端服务" class="headerlink" title="解析磁力链接后端服务"></a>解析磁力链接后端服务</h3><p>因为不清楚需要怎样的返回格式，于是查看Jackett插件的实现。Jackett搜索结果页选择任意下载，发现下载链接做了302跳转，直接调用magnet工具。那后端就很简单了，任意起一个web服务，接收<code>url</code>参数，该参数值就是bt4grpx的搜索详情页面，解析磁力链接时同样需要注意上面提到的代理和限制，最后返回只需要重定向到磁力链接即可。<br>至此，整个插件算是调试的比较好用了，搜索也只需要请求分页数一样的次数，可以正常返回搜索结果，下载也能正确的解析出磁力链接。</p><blockquote><p>Perfect ~</p></blockquote><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/qemu-docker-dsm-boot">qemu-docker 引导黑群晖 </a></span><span class="next"><a href="/posts/cloud-native-logging-notes">Cloud Native Logging Notes</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>