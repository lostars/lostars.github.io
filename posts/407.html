<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>TOMCAT 8 COOKIEPROCESSOR 实现变化 - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>TOMCAT 8 COOKIEPROCESSOR 实现变化</h1><div><time>2018-08-24</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/dev/">dev</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/java/">java</a></span></div></div></header><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>Tomcat 从7升级到8的时候出现了 java.lang.IllegalArgumentException: An invalid domain [.xxx.com] was specified for this cookie 异常。</p><p>配置中有这么段配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">useHttpOnly</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">sessionCookiePath</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">sessionCookieDomain</span>=<span class="hljs-string">&quot;.xxx.cn&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>在tomcat context.xml中配置:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">CookieProcessor</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.http.LegacyCookieProcessor&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>即可，或者你也可以把域名前面的.去掉。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>Tomcat 8更换了默认的 CookieProcessor 实现为 Rfc6265CookieProcessor，之前的实现为LegacyCookieProcessor。前者是基于 RFC6265，而后者基于RFC6265、RFC2109、RFC2616。</p><p>RFC6265中关于domain有这么一段描述：</p><blockquote><p>Domain&#x3D;domain<br>Optional. The Domain attribute specifies the domain for which the<br>cookie is valid. An explicitly specified domain must always start<br>with a dot.</p></blockquote><p>而在RFC6265中：</p><blockquote><p>If the attribute-name case-insensitively matches the string “Domain”,<br>the user agent MUST process the cookie-av as follows.</p><p>If the attribute-value is empty, the behavior is undefined. However,<br>the user agent SHOULD ignore the cookie-av entirely.</p><p>If the first character of the attribute-value string is %x2E (“.”):</p><p>Let cookie-domain be the attribute-value without the leading %x2E<br>(“.”) character.</p><p>Otherwise:</p><p>Let cookie-domain be the entire attribute-value.</p><p>Convert the cookie-domain to lower case.</p></blockquote><p>一个说要.一个说不要，那再来看看具体代码实现（generateHeader方法）。</p><p>LegacyCookieProcessor（省略了部分代码）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateHeader</span><span class="hljs-params">(Cookie cookie)</span> &#123;<br>        ......<br>        <span class="hljs-type">String</span> <span class="hljs-variable">domain</span> <span class="hljs-operator">=</span> cookie.getDomain();<br>        ......<br>        <span class="hljs-comment">// Add domain information, if present</span><br>        <span class="hljs-keyword">if</span> (domain != <span class="hljs-literal">null</span>) &#123;<br>                buf.append(<span class="hljs-string">&quot;; Domain=&quot;</span>);<br>                maybeQuote(buf, domain, version);<br>        &#125;<br>        ......<br>&#125;<br></code></pre></td></tr></table></figure><p>再看看maybeQuote方法实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">maybeQuote</span><span class="hljs-params">(StringBuffer buf, String value, <span class="hljs-type">int</span> version)</span> &#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span> || value.length() == <span class="hljs-number">0</span>) &#123;<br>            buf.append(<span class="hljs-string">&quot;\&quot;\&quot;&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (alreadyQuoted(value)) &#123;<br>            buf.append(<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>            escapeDoubleQuotes(buf, value,<span class="hljs-number">1</span>,value.length()-<span class="hljs-number">1</span>);<br>            buf.append(<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (needsQuotes(value, version)) &#123;<br>            buf.append(<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>            escapeDoubleQuotes(buf, value,<span class="hljs-number">0</span>,value.length());<br>            buf.append(<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            buf.append(value);<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到并没有做任何domain校验的操作；<br><code>Rfc6265CookieProcessor</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateHeader</span><span class="hljs-params">(Cookie cookie)</span> &#123;<br>        ......<br>        <span class="hljs-type">String</span> <span class="hljs-variable">domain</span> <span class="hljs-operator">=</span> cookie.getDomain();<br>        <span class="hljs-keyword">if</span> (domain != <span class="hljs-literal">null</span> &amp;amp;&amp;amp; domain.length() &amp;gt; <span class="hljs-number">0</span>) &#123;<br>            validateDomain(domain);<br>            header.append(<span class="hljs-string">&quot;; Domain=&quot;</span>);<br>            header.append(domain);<br>        &#125;<br>        ......<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateDomain</span><span class="hljs-params">(String domain)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">cur</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-type">char</span>[] chars = domain.toCharArray();<br>        <span class="hljs-keyword">while</span> (i &amp;lt; chars.length) &#123;<br>            prev = cur;<br>            cur = chars[i];<br>            <span class="hljs-keyword">if</span> (!domainValid.get(cur)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(sm.getString(<br>                        <span class="hljs-string">&quot;rfc6265CookieProcessor.invalidDomain&quot;</span>, domain));<br>            &#125;<br>            <span class="hljs-comment">// labels must start with a letter or number</span><br>            <span class="hljs-comment">// RFC6265实现</span><br>            <span class="hljs-keyword">if</span> ((prev == <span class="hljs-string">&#x27;.&#x27;</span> || prev == -<span class="hljs-number">1</span>) &amp;amp;&amp;amp; (cur == <span class="hljs-string">&#x27;.&#x27;</span> || cur == <span class="hljs-string">&#x27;-&#x27;</span>)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(sm.getString(<br>                        <span class="hljs-string">&quot;rfc6265CookieProcessor.invalidDomain&quot;</span>, domain));<br>            &#125;<br>            <span class="hljs-comment">// labels must end with a letter or number</span><br>            <span class="hljs-comment">// RFC6265实现</span><br>            <span class="hljs-keyword">if</span> (prev == <span class="hljs-string">&#x27;-&#x27;</span> &amp;amp;&amp;amp; cur == <span class="hljs-string">&#x27;.&#x27;</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(sm.getString(<br>                        <span class="hljs-string">&quot;rfc6265CookieProcessor.invalidDomain&quot;</span>, domain));<br>            &#125;<br>            i++;<br>        &#125;<br>        <span class="hljs-comment">// domain must end with a label</span><br>        <span class="hljs-keyword">if</span> (cur == <span class="hljs-string">&#x27;.&#x27;</span> || cur == <span class="hljs-string">&#x27;-&#x27;</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(sm.getString(<br>                    <span class="hljs-string">&quot;rfc6265CookieProcessor.invalidDomain&quot;</span>, domain));<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>validateDomain方法中实现了RFC6265，这蛋疼的标准改动还真是随意。</p><p>参考文档：<br><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/config/cookie-processor.html">https://tomcat.apache.org/tomcat-8.5-doc/config/cookie-processor.html</a><br><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc2109">https://tools.ietf.org/html/rfc2109</a><br><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6265#section-5.2.3">https://tools.ietf.org/html/rfc6265#section-5.2.3</a><br>LegacyCookieProcessor源码<br>Rfc6265CookieProcessor源码</p><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/422">JAVA三目运算中隐藏的自动拆装箱 </a></span><span class="next"><a href="/posts/391">记一次SPRING配置文件读取问题</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>