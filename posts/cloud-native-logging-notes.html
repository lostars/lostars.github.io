<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>Cloud Native Logging Notes - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>Cloud Native Logging Notes</h1><div><time>2022-05-26</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/dev/">dev</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/notes/">notes</a></span></div></div></header><h2 id="Cloud-Native-Logging"><a href="#Cloud-Native-Logging" class="headerlink" title="Cloud Native Logging"></a>Cloud Native Logging</h2><p>应用产生稳定消息流，用于描述其在给定时间内的行为。这些日志捕获了系统中的各种事件，比如操作成功、失败，健康信息等待。日志工具收集、存储、分析这些日志。</p><p>收集、存储和分析日志是构建现代平台的关键部分，一些日志工具处理从收集到分析的各个方面，而有一些则专注处理某一方面。</p><p>由于容器环境的出现，云原生环境中的日志处理和传统日志处理相差很大。而云原生的日志处理工具仅 <code>Fluentd</code></p><table><thead><tr><th>Buzzwords</th><th>CNCF Projects</th></tr></thead><tbody><tr><td>Logging</td><td>Fluentd (graduated)</td></tr></tbody></table><h2 id="FluentBit"><a href="#FluentBit" class="headerlink" title="FluentBit"></a>FluentBit</h2><p><img src="https://docs.fluentbit.io/~/files/v0/b/gitbook-28427.appspot.com/o/assets%2F-LKKSx-3LBTCtaHbg0gl%2F-LKKTm4Y55lytnFhqfG1%2F-LKKTwUrRtRcGfkhN7YV%2Flogging_pipeline_input.png?generation=1534737500995540&alt=media"></p><h3 id="Fluentd"><a href="#Fluentd" class="headerlink" title="Fluentd"></a>Fluentd</h3><table><thead><tr><th>&#x2F;</th><th>Fluentd</th><th>Fluent Bit</th></tr></thead><tbody><tr><td>Scope</td><td>Containers &#x2F; Servers</td><td>Embedded Linux &#x2F; Containers &#x2F; Servers</td></tr><tr><td>Language</td><td>C &amp; Ruby</td><td>C</td></tr><tr><td>Memory</td><td>~40MB</td><td>~650KB</td></tr><tr><td>Performance</td><td>High Performance</td><td>High Performance</td></tr><tr><td>Dependencies</td><td>Built as a Ruby Gem, it requires a certain number of gems.</td><td>Zero dependencies, unless some special plugin requires them.</td></tr><tr><td>Plugins</td><td>More than 1000 plugins available</td><td>Around 70 plugins available</td></tr><tr><td>License</td><td>APACHE LICENSE V2</td><td>APACHE LICENSE V2</td></tr></tbody></table><h3 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h3><h4 id="Event-or-Record"><a href="#Event-or-Record" class="headerlink" title="Event or Record"></a>Event or Record</h4><p>FluentBit收集到的每一条日志都是一个事件或记录。</p><p>每个事件都包含2个部分，时间戳和消息：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[TIMESTAMP, MESSAGE]</span><br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Jan</span> <span class="hljs-number">18</span> <span class="hljs-number">12</span>:<span class="hljs-number">52</span>:<span class="hljs-number">16</span> flb systemd[<span class="hljs-number">2222</span>]: Starting GNOME Terminal Server<br><span class="hljs-attribute">Jan</span> <span class="hljs-number">18</span> <span class="hljs-number">12</span>:<span class="hljs-number">52</span>:<span class="hljs-number">16</span> flb dbus-daemon[<span class="hljs-number">2243</span>]:<span class="hljs-meta"> [session uid=1000 pid=2243] Successfully activated service &#x27;org.gnome.Terminal&#x27;</span><br><span class="hljs-meta">Jan 18 12:52:16 flb systemd[2222]: Started GNOME Terminal Server.</span><br><span class="hljs-meta">Jan 18 12:52:16 flb gsd-media-keys[2640]: # watch_fast: &quot;/org/gnome/terminal/legacy/&quot; (establishing: 0, active: 0)</span><br></code></pre></td></tr></table></figure><h4 id="Filtering"><a href="#Filtering" class="headerlink" title="Filtering"></a>Filtering</h4><p>对事件内容做修改的过程称为过滤。</p><ul><li>给事件添加ip信息或者他元信息；</li><li>筛选事件内容；</li><li>删除一些匹配的内容；</li></ul><h4 id="Tag"><a href="#Tag" class="headerlink" title="Tag"></a>Tag</h4><p>由FluentBit收集的每一个事件都会添加标签，大部分标签都是通过配置，如果不手动配置，那么会以InputPlugin的名称自动给事件添加标签。</p><h4 id="Structured-Messages"><a href="#Structured-Messages" class="headerlink" title="Structured Messages"></a>Structured Messages</h4><p>FluentBit将事件处理成结构化数据：<a target="_blank" rel="noopener" href="https://msgpack.org/">MessagePack</a>，可以理解成压缩过的JSON</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># No structured message</span><br><span class="hljs-string">&quot;Project Fluent Bit created on 1398289291&quot;</span><br><span class="hljs-meta"># Structured message</span><br>&#123;<span class="hljs-string">&quot;project&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Fluent Bit&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;created&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1398289291</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="Buffering-Storage"><a href="#Buffering-Storage" class="headerlink" title="Buffering &amp; Storage"></a>Buffering &amp; Storage</h3><p>FluentBit同时支持内存和文件系统两种缓冲方式，来保证性能和数据安全。</p><h4 id="Chunks-Memory-Filesystem-and-Backpressure"><a href="#Chunks-Memory-Filesystem-and-Backpressure" class="headerlink" title="Chunks, Memory, Filesystem and Backpressure"></a>Chunks, Memory, Filesystem and Backpressure</h4><p><strong><em>Chunks</em></strong></p><p>收集到的日志按照 <code>Chunk</code> 进行分组，一个 <code>Chunk</code> 约2M大小，默认所有的 <code>Chunk</code> 都在内存中创建。</p><p><strong><em>Buffering and Memory</em></strong></p><p>如果只配置内存缓冲，在输出有压力或者网络不佳的情况下可能导致内存占用暴涨，这个时候 InputPlugin 的 <code>mem_buf_limit</code> 配置可以对采集数据的内存进行限制，如果超过了，则会等待内存中的数据被成功处理掉才会继续采集（可能导致数据丢失和延迟）。</p><p><code>mem_buf_limit</code> 主要用于限制内存占用和保证服务存活。</p><p><strong><em>Filesystem buffering to the rescue</em></strong></p><p>当启用文件系统缓冲，在 <code>Chunk</code> 创建的时候会同时在文件系统创建一个状态为 <code>up</code> 的备份。</p><p>FluentBit默认内存中的 <code>Chunk</code> 数量为 128，通过 <code>storage.max_chunks_up</code> 来进行配置。状态为 <code>up</code> 的 <code>Chunk</code> 随时准备被处理，所有状态为 <code>down</code> 的数据都在文件系统。</p><p>当InputPlugin同时配置了 <code>mem_buf_limit</code> 和 <code>storage.type</code> 为 <code>filesystem</code> ，当内存使用超过限制，所有的数据都会被存储在文件系统中。</p><p><strong><em>Limiting Filesystem space for Chunks</em></strong></p><p>存储在文件系统的 <code>Chunk</code> 根据不同的 Output Plugin输出到不同的地方。<br><code>Chunk</code> 只有一份，不同的OutputPlugin只是不同的引用，可以通过outputPlugin的 <code>storage.total_limit_size</code> 来限制文件系统中 <code>Chunk</code> 数量。</p><p><strong><em>Memory Estimating</em></strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">(<span class="hljs-built_in">input</span> mem_buf_limit + <span class="hljs-built_in">output</span>) * <span class="hljs-number">1.2</span><br></code></pre></td></tr></table></figure><h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><ul><li>Service</li><li>Input</li><li>Filter</li><li>Output</li><li>Include File</li></ul><h4 id="Units"><a href="#Units" class="headerlink" title="Units"></a>Units</h4><table><thead><tr><th>Suffix</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>&#x2F;</td><td>When a suffix is not specified, it’s assumed that the value given is a bytes representation.</td><td>Specifying a value of 32000, means 32000 bytes</td></tr><tr><td>k, K, KB, kb</td><td>Kilobyte: a unit of memory equal to 1,000 bytes.</td><td>32k means 32000 bytes.</td></tr><tr><td>m, M, MB, mb</td><td>Megabyte: a unit of memory equal to 1,000,000 bytes</td><td>1M means 1000000 bytes</td></tr><tr><td>g, G, GB, gb</td><td>Gigabyte: a unit of memory equal to 1,000,000,000 bytes</td><td>1G means 1000000000 bytes</td></tr></tbody></table><h4 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h4><table><thead><tr><th>Command</th><th>Prototype</th><th>Description</th></tr></thead><tbody><tr><td>@INCLUDE</td><td>@INCLUDE FILE</td><td>Include a configuration file</td></tr><tr><td>@SET</td><td>@SET KEY&#x3D;VAL</td><td>Set a configuration variable</td></tr></tbody></table><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs routeros">@<span class="hljs-built_in">SET</span> <span class="hljs-attribute">my_input</span>=cpu<br>@<span class="hljs-built_in">SET</span> <span class="hljs-attribute">my_output</span>=stdout<br><br>[SERVICE]<br>    Flush 1<br><br>[INPUT]<br>    Name <span class="hljs-variable">$&#123;my_input&#125;</span><br><br>[OUTPUT]<br>    Name <span class="hljs-variable">$&#123;my_output&#125;</span><br></code></pre></td></tr></table></figure><h4 id="Record-Accessor"><a href="#Record-Accessor" class="headerlink" title="Record Accessor"></a>Record Accessor</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;log&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;some message&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;stream&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;stdout&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;labels&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>     <span class="hljs-attr">&quot;color&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> <br>     <span class="hljs-attr">&quot;unset&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>     <span class="hljs-attr">&quot;project&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;env&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;production&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>Format</th><th>Accessed Value</th></tr></thead><tbody><tr><td>$log</td><td>“some message”</td></tr><tr><td>$labels[‘color’]</td><td>“blue”</td></tr><tr><td>$labels[‘project’][‘env’]</td><td>“production”</td></tr><tr><td>$labels[‘unset’]</td><td>null</td></tr><tr><td>$labels[‘undefined’]</td><td></td></tr></tbody></table><h3 id="Inputs"><a href="#Inputs" class="headerlink" title="Inputs"></a>Inputs</h3><p>FluentBit支持多种日志收集，同时也支持cpu、硬盘等硬件指标收集。</p><h4 id="Systemd"><a href="#Systemd" class="headerlink" title="Systemd"></a><a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/pipeline/inputs/systemd">Systemd</a></h4><table><thead><tr><th>Key</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td>Path</td><td>journal文件夹，不设置则使用默认路径</td><td></td></tr><tr><td>Systemd_Filter</td><td>过滤日志，_SYSTEMD_UNIT&#x3D;td-agent-bit.service 可以设置多个</td><td></td></tr><tr><td>Systemd_Filter_Type</td><td>Systemd_Filter设置多个之后匹配规则，可选 And Or</td><td>Or</td></tr><tr><td>DB</td><td>Journald 指针存储位置</td><td></td></tr><tr><td>Read_From_Tail</td><td>是否从尾部读取日志</td><td>Off</td></tr></tbody></table><h4 id="Tail"><a href="#Tail" class="headerlink" title="Tail"></a><a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/pipeline/inputs/tail">Tail</a></h4><table><thead><tr><th>Key</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td>Path</td><td>文件位置，逗号隔开配置多个</td><td></td></tr><tr><td>DB</td><td>存储文件offset</td><td></td></tr></tbody></table><h3 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h3><h4 id="Rewrite-Tag"><a href="#Rewrite-Tag" class="headerlink" title="Rewrite Tag"></a><a target="_blank" rel="noopener" href="https://docs.fluentbit.io/manual/pipeline/filters/rewrite-tag">Rewrite Tag</a></h4><p>FluentBit可以将收集到的日志重写标签，生成新的日志，同时可以配置是否保留修改前的日志。</p><table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td>Rule</td><td><code>KEY REGEX NEW_TAG KEEP</code> 需要匹配的key，匹配value的正则，新标签名称，是否保留原有日志</td></tr><tr><td>Emitter_Mem_Buf_Limit</td><td>内存占用配置，默认10M</td></tr><tr><td>Emitter_Storage.type</td><td>存储类型，<code>memory</code> or <code>filesystem</code></td></tr><tr><td>Emitter_Name</td><td>执行重写操作的是FluentBit的一个内部插件，这个配置的是这个插件的名称</td></tr></tbody></table><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">SERVICE</span>]<br>    Flush     <span class="hljs-number">1</span><br>    Log_Level info<br><br>[<span class="hljs-meta">INPUT</span>]<br>    NAME   dummy<br>    Dummy  &#123;<span class="hljs-string">&quot;tool&quot;</span>: <span class="hljs-string">&quot;fluent&quot;</span>, <span class="hljs-string">&quot;sub&quot;</span>: &#123;<span class="hljs-string">&quot;s1&quot;</span>: &#123;<span class="hljs-string">&quot;s2&quot;</span>: <span class="hljs-string">&quot;bit&quot;</span>&#125;&#125;&#125;<br>    Tag    test_tag<br><br>[<span class="hljs-meta">FILTER</span>]<br>    Name          rewrite_tag<br>    Match         test_tag<br>    <span class="hljs-meta">#             fluent  包含fluent字符串 重写之后的标签  不保留之前的日志</span><br>    Rule          $tool ^(fluent)$  <span class="hljs-keyword">from</span>.$TAG.<span class="hljs-keyword">new</span>.$tool.$sub[<span class="hljs-string">&#x27;s1&#x27;</span>][<span class="hljs-string">&#x27;s2&#x27;</span>].<span class="hljs-keyword">out</span> <span class="hljs-literal">false</span><br>    Emitter_Name  re_emitted<br><br>[<span class="hljs-meta">OUTPUT</span>]<br>    Name   stdout<br>    Match  <span class="hljs-keyword">from</span>.*<br></code></pre></td></tr></table></figure><h3 id="Outputs"><a href="#Outputs" class="headerlink" title="Outputs"></a>Outputs</h3><p>FluentBit支持各种输出，Loki、ES、InfluxDB、Kafka等后端存储，AmazonS3、Azure等云存储，或者是标准输出，也可以转发到另外的FluentBit或者Fluentd。</p><h4 id="Loki"><a href="#Loki" class="headerlink" title="Loki"></a>Loki</h4><p>Key | Description | Default<br>host | Loki hostname or IP address | 127.0.0.1<br>port | Loki TCP port | 3100<br>labels | 标签，多个用逗号隔开，除了固定标签，也可以使用RecordAccesor | job&#x3D;fluentbit<br>line_format | 格式化，<code>json</code> or <code>key_value</code> | json<br>auto_kubernetes_labels | 是否自动解析k8s标签 | off<br>label_keys | 同<code>labels</code>，但是不能自定义label名称 |</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[OUTPUT]<br>        Name                   loki<br>        Host                   <span class="hljs-variable">$&#123;LOKI_HOST&#125;</span><br>       <span class="hljs-built_in"> Port </span>                  <span class="hljs-variable">$&#123;LOKI_PORT&#125;</span><br>        Match                  *<br>        Labels                 <span class="hljs-attribute">job</span>=fluentbit-kube, <span class="hljs-attribute">container</span>=<span class="hljs-variable">$kubernetes</span>[<span class="hljs-string">&#x27;container_name&#x27;</span>], <span class="hljs-attribute">namespace</span>=<span class="hljs-variable">$kubernetes</span>[<span class="hljs-string">&#x27;namespace_name&#x27;</span>], <span class="hljs-attribute">host</span>=<span class="hljs-variable">$kubernetes</span>[<span class="hljs-string">&#x27;host&#x27;</span>], <span class="hljs-attribute">stream</span>=<span class="hljs-variable">$stream</span><br>        # 使用label_keys 则只能配置 <span class="hljs-attribute">container</span>=<span class="hljs-variable">$kubernetes</span>[<span class="hljs-string">&#x27;container_name&#x27;</span>]<br>        Auto_Kubernetes_Labels off<br></code></pre></td></tr></table></figure><h3 id="Deploy"><a href="#Deploy" class="headerlink" title="Deploy"></a>Deploy</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">helm install fluentbit-operator -n<span class="hljs-built_in"> logging </span>charts/fluentbit-operator/ --<span class="hljs-built_in">set</span> <span class="hljs-attribute">containerRuntime</span>=docker<br></code></pre></td></tr></table></figure><details><summary>DaemonSet配置</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluent-bit-logging</span><br>    <span class="hljs-attr">version:</span> <span class="hljs-string">v1</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluent-bit-logging</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluent-bit-logging</span><br>        <span class="hljs-attr">version:</span> <span class="hljs-string">v1</span><br>        <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">prometheus.io/scrape:</span> <span class="hljs-string">&quot;true&quot;</span><br>        <span class="hljs-attr">prometheus.io/port:</span> <span class="hljs-string">&quot;2020&quot;</span><br>        <span class="hljs-attr">prometheus.io/path:</span> <span class="hljs-string">/api/v1/metrics/prometheus</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">fluent/fluent-bit:1.8.10</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">2020</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LOKI_HOST</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;loki.logging.svc&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">LOKI_PORT</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;3100&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">STORAGE_PATH</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;/var/log/fluentbit/&quot;</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">storage-path</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log/fluentbit</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlibdockercontainers</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/docker/containers</span><br>          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit-config</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/fluent-bit/etc/</span><br>      <span class="hljs-attr">terminationGracePeriodSeconds:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">storage-path</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log/fluentbit</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlog</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">varlibdockercontainers</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/var/lib/docker/containers</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit-config</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit-config</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">fluent-bit</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">node-role.kubernetes.io/master</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>        <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoSchedule&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit-read</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span> [<span class="hljs-string">&quot;&quot;</span>]<br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">namespaces</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>  <span class="hljs-attr">verbs:</span> [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit-read</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit-read</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluent-bit</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">2020</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">2020</span><br></code></pre></td></tr></table></figure></details><details><summary>configmap</summary><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluent-bit-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">logging</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluent-bit</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-comment"># Configuration files: server, input, filters and output</span><br>  <span class="hljs-comment"># ======================================================</span><br>  <span class="hljs-attr">fluent-bit.conf:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    [SERVICE]</span><br><span class="hljs-string">        Flush         1</span><br><span class="hljs-string">        Log_Level     info</span><br><span class="hljs-string">        Daemon        off</span><br><span class="hljs-string">        Parsers_File  parsers.conf</span><br><span class="hljs-string">        HTTP_Server   On</span><br><span class="hljs-string">        HTTP_Listen   0.0.0.0</span><br><span class="hljs-string">        HTTP_Port     2020</span><br><span class="hljs-string">        storage.path  $&#123;STORAGE_PATH&#125;</span><br><span class="hljs-string">        storage.backlog.mem_limit  5M</span><br><span class="hljs-string"></span><br>    <span class="hljs-string">@INCLUDE</span> <span class="hljs-string">input-kubernetes.conf</span><br>    <span class="hljs-string">@INCLUDE</span> <span class="hljs-string">filter-kubernetes.conf</span><br>    <span class="hljs-string">@INCLUDE</span> <span class="hljs-string">output-loki.conf</span><br><br>  <span class="hljs-attr">input-kubernetes.conf:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    [INPUT]</span><br><span class="hljs-string">        Name              tail</span><br><span class="hljs-string">        Tag               kube.*</span><br><span class="hljs-string">        Path              /var/log/containers/*.log</span><br><span class="hljs-string">        Parser            docker</span><br><span class="hljs-string">        DB                /var/log/flb_kube.db</span><br><span class="hljs-string">        Mem_Buf_Limit     5MB</span><br><span class="hljs-string">        Skip_Long_Lines   On</span><br><span class="hljs-string">        Refresh_Interval  10</span><br><span class="hljs-string">        storage.type      filesystem</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">filter-kubernetes.conf:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    [FILTER]</span><br><span class="hljs-string">        Name                kubernetes</span><br><span class="hljs-string">        Match               kube.*</span><br><span class="hljs-string">        Kube_URL            https://kubernetes.default.svc:443</span><br><span class="hljs-string">        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="hljs-string">        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="hljs-string">        Kube_Tag_Prefix     kube.var.log.containers.</span><br><span class="hljs-string">        Merge_Log           On</span><br><span class="hljs-string">        Merge_Log_Key       log_processed</span><br><span class="hljs-string">        K8S-Logging.Parser  On</span><br><span class="hljs-string">        K8S-Logging.Exclude Off</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">output-loki.conf:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    [OUTPUT]</span><br><span class="hljs-string">        Name                   loki</span><br><span class="hljs-string">        Host                   $&#123;LOKI_HOST&#125;</span><br><span class="hljs-string">        Port                   $&#123;LOKI_PORT&#125;</span><br><span class="hljs-string">        Match                  *</span><br><span class="hljs-string">        Labels                 job=fluentbit-kube, container=$kubernetes[&#x27;container_name&#x27;], namespace=$kubernetes[&#x27;namespace_name&#x27;], host=$kubernetes[&#x27;host&#x27;], stream=$stream</span><br><span class="hljs-string">        Auto_Kubernetes_Labels off</span><br><span class="hljs-string"></span><br>  <span class="hljs-attr">parsers.conf:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    [PARSER]</span><br><span class="hljs-string">        Name   apache</span><br><span class="hljs-string">        Format regex</span><br><span class="hljs-string">        Regex  ^(?&lt;host&gt;[^ ]*) [^ ]* (?&lt;user&gt;[^ ]*) \[(?&lt;time&gt;[^\]]*)\] &quot;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\&quot;]*?)(?: +\S*)?)?&quot; (?&lt;code&gt;[^ ]*) (?&lt;size&gt;[^ ]*)(?: &quot;(?&lt;referer&gt;[^\&quot;]*)&quot; &quot;(?&lt;agent&gt;[^\&quot;]*)&quot;)?$</span><br><span class="hljs-string">        Time_Key time</span><br><span class="hljs-string">        Time_Format %d/%b/%Y:%H:%M:%S %z</span><br><span class="hljs-string"></span><br>    [<span class="hljs-string">PARSER</span>]<br>        <span class="hljs-string">Name</span>   <span class="hljs-string">apache2</span><br>        <span class="hljs-string">Format</span> <span class="hljs-string">regex</span><br>        <span class="hljs-string">Regex</span>  <span class="hljs-string">^(?&lt;host&gt;[^</span> <span class="hljs-string">]*)</span> [<span class="hljs-string">^</span> ]<span class="hljs-string">*</span> <span class="hljs-string">(?&lt;user&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="hljs-string">&quot;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^ ]*) +\S*)?&quot;</span> <span class="hljs-string">(?&lt;code&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">(?&lt;size&gt;[^</span> <span class="hljs-string">]*)(?:</span> <span class="hljs-string">&quot;(?&lt;referer&gt;[^\&quot;]*)&quot;</span> <span class="hljs-string">&quot;(?&lt;agent&gt;[^\&quot;]*)&quot;</span><span class="hljs-string">)?$</span><br>        <span class="hljs-string">Time_Key</span> <span class="hljs-string">time</span><br>        <span class="hljs-string">Time_Format</span> <span class="hljs-string">%d/%b/%Y:%H:%M:%S</span> <span class="hljs-string">%z</span><br><br>    [<span class="hljs-string">PARSER</span>]<br>        <span class="hljs-string">Name</span>   <span class="hljs-string">apache_error</span><br>        <span class="hljs-string">Format</span> <span class="hljs-string">regex</span><br>        <span class="hljs-string">Regex</span>  <span class="hljs-string">^\[[^</span> <span class="hljs-string">]*</span> <span class="hljs-string">(?&lt;time&gt;[^\]]*)\]</span> <span class="hljs-string">\[(?&lt;level&gt;[^\]]*)\](?:</span> <span class="hljs-string">\[pid</span> <span class="hljs-string">(?&lt;pid&gt;[^\]]*)\])?(</span> <span class="hljs-string">\[client</span> <span class="hljs-string">(?&lt;client&gt;[^\]]*)\])?</span> <span class="hljs-string">(?&lt;message&gt;.*)$</span><br><br>    [<span class="hljs-string">PARSER</span>]<br>        <span class="hljs-string">Name</span>   <span class="hljs-string">nginx</span><br>        <span class="hljs-string">Format</span> <span class="hljs-string">regex</span><br>        <span class="hljs-string">Regex</span> <span class="hljs-string">^(?&lt;remote&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">(?&lt;host&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">(?&lt;user&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">\[(?&lt;time&gt;[^\]]*)\]</span> <span class="hljs-string">&quot;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\&quot;]*?)(?: +\S*)?)?&quot;</span> <span class="hljs-string">(?&lt;code&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">(?&lt;size&gt;[^</span> <span class="hljs-string">]*)(?:</span> <span class="hljs-string">&quot;(?&lt;referer&gt;[^\&quot;]*)&quot;</span> <span class="hljs-string">&quot;(?&lt;agent&gt;[^\&quot;]*)&quot;</span><span class="hljs-string">)?$</span><br>        <span class="hljs-string">Time_Key</span> <span class="hljs-string">time</span><br>        <span class="hljs-string">Time_Format</span> <span class="hljs-string">%d/%b/%Y:%H:%M:%S</span> <span class="hljs-string">%z</span><br><br>    [<span class="hljs-string">PARSER</span>]<br>        <span class="hljs-string">Name</span>   <span class="hljs-string">json</span><br>        <span class="hljs-string">Format</span> <span class="hljs-string">json</span><br>        <span class="hljs-string">Time_Key</span> <span class="hljs-string">time</span><br>        <span class="hljs-string">Time_Format</span> <span class="hljs-string">%d/%b/%Y:%H:%M:%S</span> <span class="hljs-string">%z</span><br><br>    [<span class="hljs-string">PARSER</span>]<br>        <span class="hljs-string">Name</span>        <span class="hljs-string">docker</span><br>        <span class="hljs-string">Format</span>      <span class="hljs-string">json</span><br>        <span class="hljs-string">Time_Key</span>    <span class="hljs-string">time</span><br>        <span class="hljs-string">Time_Format</span> <span class="hljs-string">%Y-%m-%dT%H:%M:%S.%L</span><br>        <span class="hljs-string">Time_Keep</span>   <span class="hljs-string">On</span><br><br>    [<span class="hljs-string">PARSER</span>]<br>        <span class="hljs-comment"># http://rubular.com/r/tjUt3Awgg4</span><br>        <span class="hljs-string">Name</span> <span class="hljs-string">cri</span><br>        <span class="hljs-string">Format</span> <span class="hljs-string">regex</span><br>        <span class="hljs-string">Regex</span> <span class="hljs-string">^(?&lt;time&gt;[^</span> <span class="hljs-string">]+)</span> <span class="hljs-string">(?&lt;stream&gt;stdout|stderr)</span> <span class="hljs-string">(?&lt;logtag&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">(?&lt;message&gt;.*)$</span><br>        <span class="hljs-string">Time_Key</span>    <span class="hljs-string">time</span><br>        <span class="hljs-string">Time_Format</span> <span class="hljs-string">%Y-%m-%dT%H:%M:%S.%L%z</span><br><br>    [<span class="hljs-string">PARSER</span>]<br>        <span class="hljs-string">Name</span>        <span class="hljs-string">syslog</span><br>        <span class="hljs-string">Format</span>      <span class="hljs-string">regex</span><br>        <span class="hljs-string">Regex</span>       <span class="hljs-string">^\&lt;(?&lt;pri&gt;[0-9]+)\&gt;(?&lt;time&gt;[^</span> <span class="hljs-string">]*</span> &#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>&#125;[<span class="hljs-string">^</span> ]<span class="hljs-string">*</span> [<span class="hljs-string">^</span> ]<span class="hljs-string">*)</span> <span class="hljs-string">(?&lt;host&gt;[^</span> <span class="hljs-string">]*)</span> <span class="hljs-string">(?&lt;ident&gt;[a-zA-Z0-9_\/\.\-]*)(?:\[(?&lt;pid&gt;[0-9]+)\])?(?:[^\:]*\:)?</span> <span class="hljs-string">*(?&lt;message&gt;.*)$</span><br>        <span class="hljs-string">Time_Key</span>    <span class="hljs-string">time</span><br>        <span class="hljs-string">Time_Format</span> <span class="hljs-string">%b</span> <span class="hljs-string">%d</span> <span class="hljs-string">%H:%M:%S</span><br></code></pre></td></tr></table></figure></details><h3 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h3><p><a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-bit/issues/3581">FluentBit卡住，re-schedule retry&#x3D;0x7f012a85a298 0 in the next 8 seconds</a><br><a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-bit/issues/3328">Loki Output插件在Loki从挂掉到恢复正常后无法正确push日志</a><br><a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-bit/issues/4373"></a><br><a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-bit/issues/4221"></a><br><a target="_blank" rel="noopener" href="https://github.com/fluent/fluent-bit/issues/2110"></a></p><h2 id="Loki-1"><a href="#Loki-1" class="headerlink" title="Loki"></a>Loki</h2><p><img src="https://grafana.com/docs/loki/latest/fundamentals/overview/loki-overview-2.png"></p><p>Loki支持多种Agent:</p><ul><li>Promtail</li><li>FluentBit</li><li>Fluentd</li><li>Logstash</li><li>……</li></ul><p>主要特性：</p><ul><li>更高效的内存使用，只索引labels。<br>不像其他日志系统，Loki只针对日志metadata做索引：label，日志本身压缩存储到对象存储或者本地文件系统中。</li><li>多租户 Loki允许多租户共享，数据彼此间完全隔离。Agent可以通过配置 tenant ID 来进行区分。</li><li>LogQL</li><li>可扩展性 Loki所有组件可以跑在同一个进程中，每个组件也可以作为微服务运行。</li><li>灵活性 多种Agent都有插件支持。</li><li>Grafana集成 官方支持Loki数据源</li></ul><h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><h4 id="多租户"><a href="#多租户" class="headerlink" title="多租户"></a>多租户</h4><p>Loki多租户模式下在拉取数据的时候通过请求头 <code>X-Scope-OrgID</code> 来进行区分，未配置多租户时该请求头被忽略并且统一设置为 <code>fake</code>。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">[auth_enabled: &lt;<span class="hljs-type">boolean</span>&gt; | <span class="hljs-keyword">default</span> = <span class="hljs-literal">true</span>]<br></code></pre></td></tr></table></figure><p>Loki提供3种部署模式，使用 <code>-target</code> 来进行配置。</p><h4 id="Monolithic-mode"><a href="#Monolithic-mode" class="headerlink" title="Monolithic mode"></a>Monolithic mode</h4><p>通过 <code>-target=all</code> 配置，默认为该模式。Loki的所有组件和服务均跑在同一个进程中。</p><p><img src="https://grafana.com/docs/loki/latest/fundamentals/architecture/monolithic-mode.png"></p><p>该模式适合每天读写量在100g的场景。需要水平扩展可以通过 <code>memberlist_config</code> 来进行配置。<br>流量通过循环的方式路由到各个实例，而查询的并发则有实例数量和配置进行控制。</p><h4 id="Simple-scalable-deployment-mode"><a href="#Simple-scalable-deployment-mode" class="headerlink" title="Simple scalable deployment mode"></a>Simple scalable deployment mode</h4><p>适合每天读写量在几百g的场景，同时也可以通过 <code>-target=read</code> <code>-target=write</code> 来分离读写以支持达每天TB级别的数据量，</p><p><img src="https://grafana.com/docs/loki/latest/fundamentals/architecture/simple-scalable.png"></p><p>读写分离的好处：</p><ul><li>可以通过扩展来提高写性能；</li><li>可以根据需要单独配置读取性能，增加或减少；</li></ul><h4 id="Microservices-mode"><a href="#Microservices-mode" class="headerlink" title="Microservices mode"></a>Microservices mode</h4><p><img src="https://grafana.com/docs/loki/latest/fundamentals/architecture/microservices-mode.png"></p><p>通过 <code>-target</code> 来指定不同的部署组件：</p><ul><li>ingester</li><li>distributor</li><li>query-frontend</li><li>query-scheduler</li><li>querier</li><li>index-gateway</li><li>ruler</li><li>compactor</li></ul><p>微服务模式是最为高效的Loki部署方式，但是也是最复杂的。该方式适用于超大型Loki集群，同时对扩展和操作要求更多的场景。<br>同时微服务模式也是更适合K8s部署。</p><h4 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h4><p><img src="https://grafana.com/docs/loki/latest/fundamentals/architecture/loki_architecture_components.svg"></p><p><strong>Distributor</strong></p><p>Distributor是Loki处理日志的第一站，用于处理客户端的日志流，同时对流进行验证并且保证在租户或全局配置限制之内。然后将验证过的Chunk分批并行发送给ingesters。</p><p>Distributor是无状态的，且通过grpc和Ingester通信，他的数量可以按需增减，同时最好在前部署一个负载均衡。</p><ul><li>Validation 做数据合法性检查，比如label是否合法；</li><li>Preprocessing 规范化标签，让 <code>&#123;foo=&quot;bar&quot;, bazz=&quot;buzz&quot;&#125;</code>等于 <code>&#123;bazz=&quot;buzz&quot;, foo=&quot;bar&quot;&#125;</code> ；</li><li>Rate limiting Distributor通过Ring来发现其他节点</li><li>Forwarding</li></ul><p>Distributor使用一致性哈希（租户id，label）来判断流应该被哪些Ingester处理（hash lookup）。<br>Distributor从Ingester ring中查询到大于流hash值最小的那个Ingester，如果 <code>replication_factor</code> 设置大于1，那么ring中后续 <code>replication_factor - 1</code> 个Ingester都会处理该stream。如果处理成功的个数小于 <code>quorum</code>，那么distributor就会返回写入失败。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">quorum</span> = floor(replication_factor / <span class="hljs-number">2</span>) + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><strong>Ingester</strong></p><p>用于写入数据，同时也处理内存中数据的查询。Ingester有5种状态：</p><ul><li>PENDING 等待状态为 <code>LEAVING</code> 节点的交接；</li><li>JOINING 正在加入hash ring和初始化自己，此时有可能处理写请求；</li><li>ACTIVE 完全准备好处理读写请求；</li><li>LEAVING 节点关闭中，可能处理读取内存中的数据；</li><li>UNHEALTHY 心跳失败的节点，该状态是由Distributor定期检查设置上的；</li></ul><p>Ingester将数据写入 <code>chunks</code>(内存中)，定时再将其写入后端存储。</p><p>下面情况Chunks将被压缩和标记为只读（同时一个替代Chunk也会被创建）：</p><ul><li>Chunk容量达到限制；</li><li>距离上次被更新过了太久时间；</li><li>正在被写入后端存储；</li></ul><p>Chunk写入后端存储时，hash都是基于租户id，label，内容，所以不会出现相同内容被写入多次的问题出现。<br>如果Ingester意外崩溃，内存中的数据会丢失，可以配置 Write Ahead Log 来避免。<br>但是如果上面的例子写入失败，最终重试会导致相同数据的产生。</p><p>Loki默认开启out-of-order写入，如果关闭该选项，对同一个流：</p><ul><li>新的数据如果在时间戳和内容上一致，会被当做相同数据，新的数据会被忽略并丢弃；</li><li>如果时间戳一致，内容不一致，数据会被写入，在同一个时间戳会有多条数据；</li></ul><p><strong>Querier</strong></p><p>Querier服务使用LogQL进行数据查询，同时从后端存储和ingester查询数据。Querier会将相同时间戳，标签和内容的数据进行删除。</p><p><strong>Query frontend</strong></p><p>这个服务可选且是无状态的，内部维护一个请求队列，让后面的Querier来拉取进行进行处理：</p><ul><li>避免大的查询导致OOM；</li><li>将大的查询分发到多个Querier来提升效率和减轻压力；</li><li>通过合理调度避免DoS；</li></ul><p>Query frontend对metrics数据查询做了缓存（日志暂未获得支持），缓存可以使用memcached，redis等内存缓存。</p><p><img src="https://grafana.com/docs/loki/latest/fundamentals/architecture/chunks_diagram.png"></p><h4 id="Dynamo"><a href="#Dynamo" class="headerlink" title="Dynamo"></a><a target="_blank" rel="noopener" href="https://www.cs.princeton.edu/courses/archive/fall15/cos518/studpres/dynamo.pdf">Dynamo</a></h4><h3 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h3><p>Loki只索引metadata，日志本身被压缩存储在对象存储种，所以loki需要存储 indexs 和 chunks。</p><p>index存储支持：</p><ul><li>Single Store (boltdb-shipper) 2.0及以后推荐使用</li><li>Amazon DynamoDB</li><li>Google Bigtable</li><li>Apache Cassandra</li><li>BoltDB 集群模式下不可用</li></ul><p>chunk存储支持：</p><ul><li>Amazon DynamoDB</li><li>Google Bigtable</li><li>Apache Cassandra</li><li>Amazon S3</li><li>Google Cloud Storage</li><li>Filesystem</li></ul><h4 id="Filesystem"><a href="#Filesystem" class="headerlink" title="Filesystem"></a>Filesystem</h4><p>优点：</p><ul><li>易于使用和配置，每个租户单独一个文件夹存储数据，如果没有配置多租户则创建一个fake文件夹。<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">storage_config:</span><br><span class="hljs-attr">filesystem:</span><br>  <span class="hljs-attr">directory:</span> <span class="hljs-string">/tmp/loki/</span><br></code></pre></td></tr></table></figure></li></ul><p>缺点：</p><ul><li>单个目录存储的文件数是限制的；</li><li>数据持久性不如对象存储稳定；</li><li>Loki使用共享文件系统体验不好；</li></ul><h4 id="Retention"><a href="#Retention" class="headerlink" title="Retention"></a>Retention</h4><p><code>Compactor</code> 仅支持 <code>boltdb-shipper</code> 存储，而 <code>table manager</code> 支持所有存储。</p><p><strong>Compactor</strong></p><blockquote><p>Compactor以单例模式运行</p></blockquote><p>Compactor优先更新索引失效，在经过 <code>retention_delete_delay</code> 之后才会实际删除数据。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">compactor:</span><br>  <span class="hljs-attr">working_directory:</span> <span class="hljs-string">/data/retention</span><br>  <span class="hljs-attr">shared_store:</span> <span class="hljs-string">gcs</span><br>  <span class="hljs-attr">compaction_interval:</span> <span class="hljs-string">10m</span><br>  <span class="hljs-attr">retention_enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">retention_delete_delay:</span> <span class="hljs-string">2h</span><br>  <span class="hljs-attr">retention_delete_worker_count:</span> <span class="hljs-number">150</span><br><span class="hljs-attr">schema_config:</span><br>    <span class="hljs-attr">configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span> <span class="hljs-string">&quot;2020-07-31&quot;</span><br>        <span class="hljs-attr">index:</span><br>            <span class="hljs-attr">period:</span> <span class="hljs-string">24h</span><br>            <span class="hljs-attr">prefix:</span> <span class="hljs-string">loki_index_</span><br>        <span class="hljs-attr">object_store:</span> <span class="hljs-string">gcs</span><br>        <span class="hljs-attr">schema:</span> <span class="hljs-string">v11</span><br>        <span class="hljs-attr">store:</span> <span class="hljs-string">boltdb-shipper</span><br><span class="hljs-attr">storage_config:</span><br>    <span class="hljs-attr">boltdb_shipper:</span><br>        <span class="hljs-attr">active_index_directory:</span> <span class="hljs-string">/data/index</span><br>        <span class="hljs-attr">cache_location:</span> <span class="hljs-string">/data/boltdb-cache</span><br>        <span class="hljs-attr">shared_store:</span> <span class="hljs-string">gcs</span><br>    <span class="hljs-attr">gcs:</span><br>        <span class="hljs-attr">bucket_name:</span> <span class="hljs-string">loki</span><br></code></pre></td></tr></table></figure><blockquote><p>Compactor的retention必须要要将 index.period 配置成 24h</p></blockquote><p>同时支持按照不同的流和不同租户来配置 retention</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">...</span><br><span class="hljs-attr">limits_config:</span><br>  <span class="hljs-attr">retention_period:</span> <span class="hljs-string">744h</span><br>  <span class="hljs-attr">retention_stream:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">selector:</span> <span class="hljs-string">&#x27;&#123;namespace=&quot;dev&quot;&#125;&#x27;</span><br>    <span class="hljs-attr">priority:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">period:</span> <span class="hljs-string">24h</span><br>  <span class="hljs-attr">per_tenant_override_config:</span> <span class="hljs-string">/etc/overrides.yaml</span><br><span class="hljs-string">...</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">overrides:</span><br>    <span class="hljs-attr">&quot;29&quot;:</span><br>        <span class="hljs-attr">retention_period:</span> <span class="hljs-string">168h</span><br>        <span class="hljs-attr">retention_stream:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">selector:</span> <span class="hljs-string">&#x27;&#123;namespace=&quot;prod&quot;&#125;&#x27;</span><br>          <span class="hljs-attr">priority:</span> <span class="hljs-number">2</span><br>          <span class="hljs-attr">period:</span> <span class="hljs-string">336h</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">selector:</span> <span class="hljs-string">&#x27;&#123;container=&quot;loki&quot;&#125;&#x27;</span><br>          <span class="hljs-attr">priority:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">period:</span> <span class="hljs-string">72h</span><br>    <span class="hljs-attr">&quot;30&quot;:</span><br>        <span class="hljs-attr">retention_stream:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">selector:</span> <span class="hljs-string">&#x27;&#123;container=&quot;nginx&quot;&#125;&#x27;</span><br>          <span class="hljs-attr">priority:</span> <span class="hljs-number">1</span><br>          <span class="hljs-attr">period:</span> <span class="hljs-string">24h</span><br></code></pre></td></tr></table></figure><p><strong>Table Manager</strong></p><p>Loki 支持将 indexs 和 chunks 存储到基于表的存储中，表按照时间段来进行分割。</p><p><img src="https://grafana.com/docs/loki/latest/operations/storage/table-manager-periodic-tables.png"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">schema_config:</span><br>  <span class="hljs-attr">configs:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span>   <span class="hljs-number">2019-01-01</span><br>      <span class="hljs-attr">store:</span>  <span class="hljs-string">dynamo</span><br>      <span class="hljs-attr">schema:</span> <span class="hljs-string">v10</span><br>      <span class="hljs-attr">index:</span><br>        <span class="hljs-attr">prefix:</span> <span class="hljs-string">loki_</span><br>        <span class="hljs-attr">period:</span> <span class="hljs-string">168h</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span>   <span class="hljs-number">2019-04-15</span><br>      <span class="hljs-attr">store:</span>  <span class="hljs-string">dynamo</span><br>      <span class="hljs-attr">schema:</span> <span class="hljs-string">v11</span><br>      <span class="hljs-attr">index:</span><br>        <span class="hljs-attr">prefix:</span> <span class="hljs-string">loki_</span><br>        <span class="hljs-attr">period:</span> <span class="hljs-string">168h</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">table_manager:</span><br>  <span class="hljs-attr">retention_deletes_enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">retention_period:</span> <span class="hljs-string">336h</span><br></code></pre></td></tr></table></figure><p>注意 <code>retention_period</code> 和 <code>index.period</code> 必须是24的整数倍。</p><p><img src="https://grafana.com/docs/loki/latest/operations/storage/table-manager-retention.png"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">number_of_tables_to_keep</span> = floor(retention_period / table_period) + <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="Single-Store-boltdb-shipper"><a href="#Single-Store-boltdb-shipper" class="headerlink" title="Single Store(boltdb shipper)"></a>Single Store(boltdb shipper)</h4><h3 id="Configuration-1"><a href="#Configuration-1" class="headerlink" title="Configuration"></a><a target="_blank" rel="noopener" href="https://grafana.com/docs/loki/latest/configuration/">Configuration</a></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 是否启用多租户</span><br><span class="hljs-attr">auth_enabled:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">chunk_store_config:</span><br>  <span class="hljs-attr">max_look_back_period:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">compactor:</span><br>  <span class="hljs-attr">retention_delete_delay:</span> <span class="hljs-string">2h</span><br>  <span class="hljs-attr">retention_delete_worker_count:</span> <span class="hljs-number">150</span><br>  <span class="hljs-attr">retention_enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">shared_store:</span> <span class="hljs-string">filesystem</span><br>  <span class="hljs-attr">working_directory:</span> <span class="hljs-string">/data/loki/boltdb-shipper-compactor</span><br><span class="hljs-attr">ingester:</span><br>  <span class="hljs-attr">chunk_block_size:</span> <span class="hljs-number">262144</span><br>  <span class="hljs-attr">chunk_idle_period:</span> <span class="hljs-string">3m</span><br>  <span class="hljs-attr">chunk_retain_period:</span> <span class="hljs-string">1m</span><br>  <span class="hljs-attr">lifecycler:</span><br>    <span class="hljs-attr">ring:</span><br>      <span class="hljs-attr">kvstore:</span><br>        <span class="hljs-attr">store:</span> <span class="hljs-string">inmemory</span><br>      <span class="hljs-attr">replication_factor:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">max_transfer_retries:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">wal:</span><br>    <span class="hljs-attr">dir:</span> <span class="hljs-string">/data/loki/wal</span><br><span class="hljs-attr">limits_config:</span><br>  <span class="hljs-attr">enforce_metric_name:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">ingestion_burst_size_mb:</span> <span class="hljs-number">16</span><br>  <span class="hljs-attr">reject_old_samples:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">reject_old_samples_max_age:</span> <span class="hljs-string">168h</span><br>  <span class="hljs-attr">retention_period:</span> <span class="hljs-string">360h</span><br><span class="hljs-attr">schema_config:</span><br>  <span class="hljs-attr">configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">from:</span> <span class="hljs-string">&quot;2020-10-24&quot;</span><br>    <span class="hljs-attr">index:</span><br>      <span class="hljs-attr">period:</span> <span class="hljs-string">24h</span><br>      <span class="hljs-attr">prefix:</span> <span class="hljs-string">index_</span><br>    <span class="hljs-attr">object_store:</span> <span class="hljs-string">filesystem</span><br>    <span class="hljs-attr">schema:</span> <span class="hljs-string">v11</span><br>    <span class="hljs-attr">store:</span> <span class="hljs-string">boltdb-shipper</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">http_listen_port:</span> <span class="hljs-number">3100</span><br><span class="hljs-attr">storage_config:</span><br>  <span class="hljs-attr">boltdb_shipper:</span><br>    <span class="hljs-attr">active_index_directory:</span> <span class="hljs-string">/data/loki/boltdb-shipper-active</span><br>    <span class="hljs-attr">cache_location:</span> <span class="hljs-string">/data/loki/boltdb-shipper-cache</span><br>    <span class="hljs-attr">cache_ttl:</span> <span class="hljs-string">24h</span><br>    <span class="hljs-attr">shared_store:</span> <span class="hljs-string">filesystem</span><br>  <span class="hljs-attr">filesystem:</span><br>    <span class="hljs-attr">directory:</span> <span class="hljs-string">/data/loki/chunks</span><br><span class="hljs-attr">table_manager:</span><br>  <span class="hljs-attr">retention_deletes_enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">retention_period:</span> <span class="hljs-string">0s</span><br></code></pre></td></tr></table></figure><p>Loki同时支持http和grpc，在<code>server</code> 下进行配置，默认不开启grpc。</p><h3 id="Deploy-Loki"><a href="#Deploy-Loki" class="headerlink" title="Deploy Loki"></a>Deploy Loki</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">helm upgrade --install --namespace=logging loki grafana/loki --<span class="hljs-built_in">set</span> <span class="hljs-string">&quot;persistence.enabled=true,persistence.storageClassName=nfs-storage,persistence.size=30Gi,config.compactor.retention_enabled=true,config.compactor.retention_delete_delay=2h,config.compactor.retention_delete_worker_count=150,config.limits_config.retention_period=360h,replicas=1,config.limits_config.ingestion_burst_size_mb=16&quot;</span><br></code></pre></td></tr></table></figure><p><a target="_blank" rel="noopener" href="https://github.com/grafana/helm-charts/blob/main/charts/loki/values.yaml">Helm配置项</a></p><h3 id="LogQL"><a href="#LogQL" class="headerlink" title="LogQL"></a>LogQL</h3><p><img src="https://grafana.com/docs/loki/latest/logql/query_components.png"></p><p>同时有多种Parser用于解析日志：</p><ul><li><code>| json</code> 用于json格式日志</li><li><code>| logfmt</code> 用于 <a target="_blank" rel="noopener" href="https://brandur.org/logfmt">logfmt</a> 格式日志</li><li><code>| pattern</code> 模式匹配</li><li><code>| regex</code> 正则匹配</li><li><code>| unpack</code> json解析</li></ul><p><strong><em>Pattern</em></strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;container<span class="hljs-punctuation">=</span><span class="hljs-string">&quot;nginx-ingress-controller&quot;</span>&#125; <span class="hljs-string">| json | line_format &quot;</span>&#123;&#123;.<span class="hljs-built_in">log</span>&#125;&#125;<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-number">192.168</span>.<span class="hljs-number">1.39</span> - - [08/Dec/<span class="hljs-number">2021</span>:<span class="hljs-number">05</span>:<span class="hljs-number">56</span>:<span class="hljs-number">31</span> +<span class="hljs-number">0000</span>] <span class="hljs-string">&quot;GET /api/datasources/proxy/15/loki/api/v1/query_range?direction=BACKWARD&amp;limit=1000&amp;query=%7Bcontainer%3D<span class="hljs-variable">%22nginx</span>-ingress-controller<span class="hljs-variable">%2</span>2%7D<span class="hljs-variable">%2</span>0%7C<span class="hljs-variable">%2</span>0json<span class="hljs-variable">%2</span>0%7C<span class="hljs-variable">%20line</span>_format<span class="hljs-variable">%2</span>0%7B<span class="hljs-variable">%7B</span>.log%7D<span class="hljs-variable">%7D</span>&amp;start=1638939392000000000&amp;end=1638942993000000000&amp;step=2 HTTP/1.1&quot;</span> <span class="hljs-number">400</span> <span class="hljs-number">75</span> <span class="hljs-string">&quot;http://grafana.minei.test/explore?orgId=1&amp;left=%5B<span class="hljs-variable">%22now</span>-1h<span class="hljs-variable">%22</span>,<span class="hljs-variable">%2</span>2now<span class="hljs-variable">%22</span>,<span class="hljs-variable">%2</span>2Loki<span class="hljs-variable">%22</span>,%7B<span class="hljs-variable">%2</span>2expr<span class="hljs-variable">%22</span>:<span class="hljs-variable">%2</span>2%7Bcontainer%3D%5C<span class="hljs-variable">%22nginx</span>-ingress-controller%5C<span class="hljs-variable">%2</span>2%7D<span class="hljs-variable">%22</span>,<span class="hljs-variable">%2</span>2hide<span class="hljs-variable">%22</span>:false%7D<span class="hljs-variable">%5D</span>&quot;</span> <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.45 Safari/537.36&quot;</span> <span class="hljs-number">825</span> <span class="hljs-number">0.003</span> [monitoring-grafana-http] [] <span class="hljs-number">10.233</span><span class="hljs-number">.108</span><span class="hljs-number">.29</span>:<span class="hljs-number">3000</span> <span class="hljs-number">75</span> <span class="hljs-number">0.002</span> <span class="hljs-number">400</span> d41b0936872b9d350a054b06658db682<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"># <span class="hljs-tag">&lt;<span class="hljs-name">label_name</span>&gt;</span> 标签名称 <br># <span class="hljs-tag">&lt;<span class="hljs-name">_</span>&gt;</span> 占位符，不做匹配<br><span class="hljs-tag">&lt;<span class="hljs-name">ip</span>&gt;</span> - - [<span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span>] &quot;<span class="hljs-tag">&lt;<span class="hljs-name">method</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">uri</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">scheme</span>&gt;</span>&quot; <span class="hljs-tag">&lt;<span class="hljs-name">status</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">request_length</span>&gt;</span> &quot;<span class="hljs-tag">&lt;<span class="hljs-name">referer</span>&gt;</span>&quot; &quot;<span class="hljs-tag">&lt;<span class="hljs-name">ua</span>&gt;</span>&quot; <span class="hljs-tag">&lt;<span class="hljs-name">response_length</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">duration</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">_</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">&#123;container=&quot;nginx-ingress-controller&quot;&#125; | json | line_format &quot;</span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">.log</span>&#125;&#125;</span><span class="language-xml">&quot; | pattern &quot;<span class="hljs-tag">&lt;<span class="hljs-name">ip</span>&gt;</span> - - [<span class="hljs-tag">&lt;<span class="hljs-name">time</span>&gt;</span>] \&quot;<span class="hljs-tag">&lt;<span class="hljs-name">method</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">uri</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">scheme</span>&gt;</span>\&quot; <span class="hljs-tag">&lt;<span class="hljs-name">status</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">request_length</span>&gt;</span> \&quot;<span class="hljs-tag">&lt;<span class="hljs-name">referer</span>&gt;</span>\&quot; \&quot;<span class="hljs-tag">&lt;<span class="hljs-name">ua</span>&gt;</span>\&quot; <span class="hljs-tag">&lt;<span class="hljs-name">response_length</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">duration</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">_</span>&gt;</span>&quot;</span><br></code></pre></td></tr></table></figure><h4 id="Log-Stream-Selector"><a href="#Log-Stream-Selector" class="headerlink" title="Log Stream Selector"></a>Log Stream Selector</h4><p>和Prometheus类似，<code>=</code> <code>!=</code> <code>=~</code> <code>!~</code>，支持4种匹配方式。</p><h4 id="Line-Filter-Expression"><a href="#Line-Filter-Expression" class="headerlink" title="Line Filter Expression"></a>Line Filter Expression</h4><p>Loki可以按照行来进行匹配，支持4种匹配方式：</p><ul><li><code>|=</code> 包含</li><li><code>!=</code> 不包含</li><li><code>|~</code> 正则匹配</li><li><code>!~</code> 不包含正则匹配</li></ul><p><code>line_format</code> 用于格式化日志行，可以使用 <code>&#123;&#123;.key&#125;&#125;</code> 来引用使用Parser格式化后的日志，比如：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;job<span class="hljs-punctuation">=</span><span class="hljs-string">&quot;fluentbit-kube&quot;</span>&#125; <span class="hljs-string">| json | line_format &quot;</span>&#123;&#123;.<span class="hljs-built_in">log</span>&#125;&#125;<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><h4 id="Label-Filter-Expression"><a href="#Label-Filter-Expression" class="headerlink" title="Label Filter Expression"></a>Label Filter Expression</h4><p>Label filter也支持对解析后的标签进行过滤：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&#123;<span class="hljs-attribute">job</span>=<span class="hljs-string">&quot;fluentbit&quot;</span>&#125; | json | <span class="hljs-attribute">PRIORITY</span>=4<br></code></pre></td></tr></table></figure><p>Loki支持4种类型的值的自动推断：</p><ul><li>String 支持 <code>=</code> <code>!=</code> <code>=~</code> <code>!~</code></li><li>Duration 支持的单位：“ns”, “us” (or “µs”), “ms”, “s”, “m”, “h”.</li><li>Number 64位浮点数</li><li>Bytes 支持的单位：“b”, “kib”, “kb”, “mib”, “mb”, “gib”, “gb”, “tib”, “tb”, “pib”, “pb”, “eib”, “eb”.</li></ul><p>多个表达式使用 <code>and</code> <code>or</code> 连接，除了字符串，其他3种类型都支持 <code>==</code> <code>=</code> <code>!=</code> <code>&gt;</code> <code>&gt;=</code> <code>&lt;</code> <code>&lt;=</code>。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&#123;<span class="hljs-attribute">job</span>=<span class="hljs-string">&quot;fluentbit&quot;</span>&#125; | json | <span class="hljs-attribute">PRIORITY</span>=4 <span class="hljs-keyword">and</span> <span class="hljs-attribute">SYSLOG_FACILITY</span>=3 <span class="hljs-keyword">and</span> <span class="hljs-attribute">_HOSTNAME</span>=~&quot;local.*&quot;<br></code></pre></td></tr></table></figure><p><code>| label_format</code> 可以重命名、修改和添加标签。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 添加host标签，值等于hostname标签的值</span><br><span class="hljs-comment"># 将job标签的值修改为f</span><br><span class="hljs-comment"># 将job标签替换为newjob</span><br>&#123;<span class="hljs-attribute">job</span>=<span class="hljs-string">&quot;fluentbit&quot;</span>&#125; | label_format <span class="hljs-attribute">host</span>=<span class="hljs-string">&quot;&#123;&#123;.hostname&#125;&#125;&quot;</span> | label_format <span class="hljs-attribute">job</span>=<span class="hljs-string">&quot;f&quot;</span> | label_format <span class="hljs-attribute">newjob</span>=job<br></code></pre></td></tr></table></figure><p>同时在解析日之后也可以进行添加标签操作：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 此时的标签值必须是解析后对应key的值</span><br>&#123;<span class="hljs-attribute">job</span>=<span class="hljs-string">&quot;fluentbit&quot;</span>&#125; | json <span class="hljs-attribute">p</span>=<span class="hljs-string">&quot;PRIORITY&quot;</span><br></code></pre></td></tr></table></figure><h4 id="Metric-queries"><a href="#Metric-queries" class="headerlink" title="Metric queries"></a><a target="_blank" rel="noopener" href="https://grafana.com/docs/loki/latest/logql/metric_queries/">Metric queries</a></h4><p>Loki也支持metrics的存储，和Prometheus类似。</p><h2 id="Loki-Promtail"><a href="#Loki-Promtail" class="headerlink" title="Loki Promtail"></a>Loki Promtail</h2><h3 id="Deploy-1"><a href="#Deploy-1" class="headerlink" title="Deploy"></a>Deploy</h3><p><a target="_blank" rel="noopener" href="https://github.com/grafana/helm-charts/blob/main/charts/promtail/values.yaml"></a></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">helm<span class="hljs-built_in"> upgrade </span>--install <span class="hljs-attribute">--namespace</span>=logging promtail grafana/promtail --<span class="hljs-built_in">set</span> <span class="hljs-string">&quot;config.lokiAddress=http://loki.logging.svc:3100/loki/api/v1/push&quot;</span><br></code></pre></td></tr></table></figure><h3 id="Configuration-2"><a href="#Configuration-2" class="headerlink" title="Configuration"></a>Configuration</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 配置Promtail</span><br>[<span class="hljs-attr">server:</span> <span class="hljs-string">&lt;server_config&gt;</span>]<br><br><span class="hljs-comment"># 配置Loki地址，多租户等信息</span><br><span class="hljs-attr">clients:</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-string">&lt;client_config&gt;</span>]<br><br><span class="hljs-comment"># 日志读取记录位置</span><br>[<span class="hljs-attr">positions:</span> <span class="hljs-string">&lt;position_config&gt;</span>]<br><br><span class="hljs-comment"># 日志采集配置</span><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-bullet">-</span> [<span class="hljs-string">&lt;scrape_config&gt;</span>]<br><br>[<span class="hljs-attr">target_config:</span> <span class="hljs-string">&lt;target_config&gt;</span>]<br></code></pre></td></tr></table></figure><p><code>scrape_configs</code> 按照job来进行区分，支持</p><ul><li>syslog</li><li>journal</li><li>kafka</li><li>windows_events</li><li>loki_push_api 从其他Promtail客户端接收日志</li><li>static_config 直接从文件读取</li><li>kubernetes_sd_config 集群日志读取</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">http_listen_port:</span> <span class="hljs-number">9080</span><br><br><span class="hljs-attr">positions:</span><br>  <span class="hljs-attr">filename:</span> <span class="hljs-string">/root/jn/prometail-positions.yaml</span><br><br><span class="hljs-attr">clients:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">http://loki.minei.test/loki/api/v1/push</span><br><br><span class="hljs-attr">scrape_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">journal</span><br>    <span class="hljs-attr">journal:</span><br>      <span class="hljs-attr">max_age:</span> <span class="hljs-string">1h</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">job:</span> <span class="hljs-string">promtail-systemd-journal</span><br>        <span class="hljs-attr">machine:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.125</span><br>    <span class="hljs-attr">relabel_configs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">&#x27;__journal__systemd_unit&#x27;</span>]<br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">&#x27;system_unit&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">&#x27;__journal___machine_id&#x27;</span>]<br>        <span class="hljs-attr">target_label:</span> <span class="hljs-string">&#x27;machine_id&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="Stages"><a href="#Stages" class="headerlink" title="Stages"></a><a target="_blank" rel="noopener" href="https://grafana.com/docs/loki/latest/clients/promtail/stages/">Stages</a></h3><p>Parsing stages:</p><ul><li>docker</li><li>cri</li><li>regex 使用正则进行解析</li><li>json<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>  <span class="hljs-attr">expressions:</span><br>    <span class="hljs-attr">output:</span>    <span class="hljs-string">log</span><br>    <span class="hljs-attr">stream:</span>    <span class="hljs-string">stream</span><br>    <span class="hljs-attr">timestamp:</span> <span class="hljs-string">time</span><br>    <span class="hljs-attr">extra:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>    <span class="hljs-attr">expressions:</span><br>      <span class="hljs-attr">user:</span><br>    <span class="hljs-attr">source:</span> <span class="hljs-string">extra</span><br></code></pre></td></tr></table></figure><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix">&#123;<span class="hljs-string">&quot;log&quot;</span>:<span class="hljs-string">&quot;log message<span class="hljs-char escape_">\n</span>&quot;</span>,<span class="hljs-string">&quot;stream&quot;</span>:<span class="hljs-string">&quot;stderr&quot;</span>,<span class="hljs-string">&quot;time&quot;</span>:<span class="hljs-string">&quot;2019-04-30T02:12:41.8443515Z&quot;</span>,<span class="hljs-string">&quot;extra&quot;</span>:<span class="hljs-string">&quot;&#123;<span class="hljs-char escape_">\&quot;</span>user<span class="hljs-char escape_">\&quot;</span>:<span class="hljs-char escape_">\&quot;</span>marco<span class="hljs-char escape_">\&quot;</span>&#125;&quot;</span>&#125;<br></code></pre></td></tr></table></figure></li><li>replace 使用正则进行替换<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">replace:</span><br>  <span class="hljs-attr">expression:</span> <span class="hljs-string">&quot;password (\\S+)&quot;</span><br>  <span class="hljs-attr">replace:</span> <span class="hljs-string">&quot;****&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2019</span>-<span class="hljs-number">01</span>-<span class="hljs-number">01</span>T01:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>.<span class="hljs-number">000000001</span>Z stderr P i&#x27;m a log message who has sensitive information with password xyz!<br></code></pre></td></tr></table></figure>输出<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2019</span>-<span class="hljs-number">01</span>-<span class="hljs-number">01</span>T01:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>.<span class="hljs-number">000000001</span>Z stderr P i&#x27;m a log message who has sensitive information with password ****!<br></code></pre></td></tr></table></figure></li></ul><p>Transform stages:</p><ul><li>template: 使用模板对数据进行修改<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">template:</span><br>  <span class="hljs-attr">source:</span> <span class="hljs-string">app</span><br>  <span class="hljs-attr">template:</span> <span class="hljs-string">&#x27;&#123;&#123; .Value &#125;&#125;_some_suffix&#x27;</span><br></code></pre></td></tr></table></figure></li><li>pack: 将一些不需要的日志label进行打包</li></ul><p>Action stages:</p><ul><li>timestamp: 设置时间戳格式</li><li>output: 设置日志输出<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>  <span class="hljs-attr">expressions:</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">user</span><br>    <span class="hljs-attr">message:</span> <span class="hljs-string">message</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">user:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">output:</span><br>    <span class="hljs-attr">source:</span> <span class="hljs-string">message</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;user&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;alexis&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;hello, world!&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>json解析出user和message标签，最后输出从json变成文本 <code>hello, world!</code></li><li>labeldrop: 删除label</li><li>labelallow: 配置输出到Loki的label</li><li>labels: 配置输出到Loki的label<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>  <span class="hljs-attr">expressions:</span><br>    <span class="hljs-attr">stream:</span> <span class="hljs-string">stream</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">stream:</span><br></code></pre></td></tr></table></figure><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix">&#123;<span class="hljs-string">&quot;log&quot;</span>:<span class="hljs-string">&quot;log message<span class="hljs-char escape_">\n</span>&quot;</span>,<span class="hljs-string">&quot;stream&quot;</span>:<span class="hljs-string">&quot;stderr&quot;</span>,<span class="hljs-string">&quot;time&quot;</span>:<span class="hljs-string">&quot;2019-04-30T02:12:41.8443515Z&quot;</span>&#125;<br></code></pre></td></tr></table></figure>解析出stream标签，最终将该标签输出到Loki</li><li>static_labels: 静态标签</li><li>metrics: 数据指标配置 支持 <code>Counter</code> <code>Gauge</code> <code>Histogram</code> 3种指标<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">metrics:</span><br>  <span class="hljs-attr">log_lines_total:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">Counter</span><br>    <span class="hljs-attr">description:</span> <span class="hljs-string">&quot;total number of log lines&quot;</span><br>    <span class="hljs-attr">prefix:</span> <span class="hljs-string">my_promtail_custom_</span><br>    <span class="hljs-attr">max_idle_duration:</span> <span class="hljs-string">24h</span><br>    <span class="hljs-comment"># 需要匹配的标签，不填则和metric同名</span><br>    <span class="hljs-attr">source:</span> <br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-comment"># true：匹配所有的日志 不匹配source</span><br>      <span class="hljs-attr">match_all:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-comment"># `inc` 或者 `add`</span><br>      <span class="hljs-attr">action:</span> <span class="hljs-string">inc</span><br></code></pre></td></tr></table></figure></li><li>tenant: 给日志设置租户<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">pipeline_stages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>    <span class="hljs-attr">expressions:</span><br>      <span class="hljs-attr">customer_id:</span> <span class="hljs-string">customer_id</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">tenant:</span><br>    <span class="hljs-attr">source:</span> <span class="hljs-string">customer_id</span><br></code></pre></td></tr></table></figure><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nix">&#123;<span class="hljs-string">&quot;customer_id&quot;</span>:<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;log&quot;</span>:<span class="hljs-string">&quot;log message<span class="hljs-char escape_">\n</span>&quot;</span>,<span class="hljs-string">&quot;stream&quot;</span>:<span class="hljs-string">&quot;stderr&quot;</span>,<span class="hljs-string">&quot;time&quot;</span>:<span class="hljs-string">&quot;2019-04-30T02:12:41.8443515Z&quot;</span>&#125;<br></code></pre></td></tr></table></figure>最终解析到的<code>customer_id</code>为1，会添加到请求Loki后端时<code>X-Scope-OrgID</code>请求头上。</li></ul><p>Filtering stages:</p><ul><li>match: 过滤stage<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">pipeline_stages:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>    <span class="hljs-attr">expressions:</span><br>      <span class="hljs-attr">app:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span><br>    <span class="hljs-attr">selector:</span> <span class="hljs-string">&#x27;&#123;app=&quot;loki&quot;&#125;&#x27;</span><br>    <span class="hljs-attr">stages:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>        <span class="hljs-attr">expressions:</span><br>          <span class="hljs-attr">msg:</span> <span class="hljs-string">message</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span><br>    <span class="hljs-attr">pipeline_name:</span> <span class="hljs-string">&quot;app2&quot;</span><br>    <span class="hljs-attr">selector:</span> <span class="hljs-string">&#x27;&#123;app=&quot;pokey&quot;&#125;&#x27;</span><br>    <span class="hljs-attr">action:</span> <span class="hljs-string">keep</span><br>    <span class="hljs-attr">stages:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">json:</span><br>        <span class="hljs-attr">expressions:</span><br>          <span class="hljs-attr">msg:</span> <span class="hljs-string">msg</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span><br>    <span class="hljs-attr">selector:</span> <span class="hljs-string">&#x27;&#123;app=&quot;promtail&quot;&#125; |~ &quot;.*noisy error.*&quot;&#x27;</span><br>    <span class="hljs-attr">action:</span> <span class="hljs-string">drop</span><br>    <span class="hljs-attr">drop_counter_reason:</span> <span class="hljs-string">promtail_noisy_error</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">output:</span><br>    <span class="hljs-attr">source:</span> <span class="hljs-string">msg</span><br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">&#123; &quot;<span class="hljs-selector-tag">time</span>&quot;:<span class="hljs-string">&quot;2012-11-01T22:08:41+00:00&quot;</span>, <span class="hljs-string">&quot;app&quot;</span>:<span class="hljs-string">&quot;loki&quot;</span>, <span class="hljs-string">&quot;component&quot;</span>: [<span class="hljs-string">&quot;parser&quot;</span>,<span class="hljs-string">&quot;type&quot;</span>], <span class="hljs-string">&quot;level&quot;</span> : <span class="hljs-string">&quot;WARN&quot;</span>, <span class="hljs-string">&quot;message&quot;</span> : <span class="hljs-string">&quot;app1 log line&quot;</span> &#125;<br>&#123; &quot;<span class="hljs-selector-tag">time</span>&quot;:<span class="hljs-string">&quot;2012-11-01T22:08:41+00:00&quot;</span>, <span class="hljs-string">&quot;app&quot;</span>:<span class="hljs-string">&quot;promtail&quot;</span>, <span class="hljs-string">&quot;component&quot;</span>: [<span class="hljs-string">&quot;parser&quot;</span>,<span class="hljs-string">&quot;type&quot;</span>], <span class="hljs-string">&quot;level&quot;</span> : <span class="hljs-string">&quot;ERROR&quot;</span>, <span class="hljs-string">&quot;message&quot;</span> : <span class="hljs-string">&quot;foo noisy error&quot;</span> &#125;<br></code></pre></td></tr></table></figure>前2个stage解析到app标签，有两个值：loki 和 promtail。<code>match</code> 匹配到第一行日志，同时添加了msg标签，值为 <code>app1 log line</code>。下面一个match未匹配到任何数据。第三个match匹配到第二行日志，对其做了删除，同时会对 <code>logentry_dropped_lines_total</code> 指标值加一，同时添加标签 <code>reason=&quot;promtail_noisy_error&quot;</code>。最后输出msg标签的值 <code>app1 log line</code>。</li><li>drop: 按照过滤条件删除日志。</li></ul><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/qbittorrent-search-plugin-debug">qbittorrent 搜索插件调试 </a></span><span class="next"><a href="/posts/cloud-native-monitoring-notes">Cloud Native Monitoring Notes</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>