<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="shortcut icon" href="/images/blog/favicon.svg"><meta name="keywords" content=""><meta name="description" content=""><link rel="stylesheet" href="/styles/main.css"><link rel="stylesheet" href="/styles/post.css"><title>记一次SPRING配置文件读取问题 - Daydream</title><meta name="generator" content="Hexo 7.3.0"></head><body><header><nav><ul><li><a href="/">Home</a></li><li><a href="/posts/"><span>Posts</span></a></li><li><a href="/categories/"><span>Categories</span></a></li><li><a href="/about"><span>About</span></a></li></ul></nav></header><main><header><h1>记一次SPRING配置文件读取问题</h1><div><time>2018-07-03</time><div class="post-categories"><span class="category-tree"><span class="category-separator">/</span> <a href="/categories/dev/">dev</a></span></div><div class="post-tags"><span class="tag"><span class="category-separator">#</span> <a href="/tags/java/">java</a></span></div></div></header><p>一个java web项目启动时遇到了下面这么个报错：<br>java.util.prefs.WindowsPreferences.WindowsRegOpenKey1 Trying to recreate Windows registry node Software\JavaSoft\Prefs at root 0x80000002<br>很诡异的一个报错，怎么会与windows注册表相关，这个报错是一个配置文件属性加载引起的，百度很快找到了解决方式：<br>在注册表项 HKEY_LOCAL_MACHINE\Software\JavaSoft 下面新建 Prefs 项目即可。</p><p>问题是解决了，但是怎么会出现这么个报错？于是找到了配置文件的引入部分：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;propertyConfigurer&quot;</span> <span class="hljs-attr">class</span>=</span><br><span class="hljs-tag">    <span class="hljs-string">&quot;org.springframework.beans.factory.config.PreferencesPlaceholderConfigurer&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;locations&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>            ...<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure><p>这里解析配置文件用的是 PreferencesPlaceholderConfigurer 这个类，该类扩展了 PropertyPlaceholderConfigurer 类，添加了windows下用户路径和系统路径的解析。<br>看下该类的解析配置文件的核心方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Preferences systemPrefs;<br><span class="hljs-keyword">private</span> Preferences userPrefs;<br>......<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">resolvePlaceholder</span><span class="hljs-params">(String placeholder, Properties props)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> placeholder;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">endOfPath</span> <span class="hljs-operator">=</span> placeholder.lastIndexOf(<span class="hljs-string">&#x27;/&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (endOfPath != -<span class="hljs-number">1</span>) &#123;<br>        path = placeholder.substring(<span class="hljs-number">0</span>, endOfPath);<br>        key = placeholder.substring(endOfPath + <span class="hljs-number">1</span>);<br>    &#125;<br>        <span class="hljs-comment">// 首先解析用户路径</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> resolvePlaceholder(path, key, <span class="hljs-built_in">this</span>.userPrefs);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 系统路径</span><br>        value = resolvePlaceholder(path, key, <span class="hljs-built_in">this</span>.systemPrefs);<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>            value = props.getProperty(placeholder);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br></code></pre></td></tr></table></figure><p>Preferences是一个保存系统和用户配置信息的一个类，同时有下面的子类扩展关系：<br>Preferences &lt;- AbstractPreferences &lt;- WindowsPreferences<br>上面的方法会判断最后一个 &#x2F; 位置，其实就是判断key中是否包含路径，如果包含就会截取出路径去解析用户和系统的配置，最后都找不到再从 Properties 中获取。</p><p>继续看 resolvePlaceholder 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">resolvePlaceholder</span><span class="hljs-params">(String path, String key, </span><br><span class="hljs-params">    Preferences preferences)</span> &#123;<br>   <span class="hljs-keyword">if</span> (path != <span class="hljs-literal">null</span>) &#123;<br>       <span class="hljs-comment">// Do not create the node if it does not exist...</span><br>      <span class="hljs-keyword">try</span> &#123;<br>         <span class="hljs-keyword">if</span> (preferences.nodeExists(path)) &#123;<br>            <span class="hljs-keyword">return</span> preferences.node(path).get(key, <span class="hljs-literal">null</span>);<br>         &#125;<br>         <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>         &#125;<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (BackingStoreException ex) &#123;<br>         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br>             <span class="hljs-string">&quot;Cannot access specified node path [&quot;</span> + path + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>      &#125;<br>   &#125;<br>   <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> preferences.get(key, <span class="hljs-literal">null</span>);<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>nodeExists 方法是 AbstractPreferences 中的一个判断系统路径是否存在的一个方法，追踪调用链可以发现这个方法最终调用了<br>定义在 Preferences 中的 childrenNamesSpi() 方法，在 WindowsPreferences 中重写了该方法，该方法中我们可以看到最终抛出 BackingStoreException 的地方：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> String[] childrenNamesSpi() <span class="hljs-keyword">throws</span> BackingStoreException &#123;<br>    <span class="hljs-comment">// Open key</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">nativeHandle</span> <span class="hljs-operator">=</span> openKey(KEY_ENUMERATE_SUB_KEYS | KEY_QUERY_VALUE);<br>    <span class="hljs-keyword">if</span> (nativeHandle == NULL_NATIVE_HANDLE) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BackingStoreException</span>(<br>                <span class="hljs-string">&quot;Could not open windows registry node &quot;</span> +<br>                byteArrayToString(windowsAbsolutePath()) +<br>                <span class="hljs-string">&quot; at root 0x&quot;</span> +<br>                Integer.toHexString(rootNativeHandle()) + <span class="hljs-string">&quot;.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// Get number of children</span><br>    ......<br>    <span class="hljs-comment">// Get children</span><br>    ......<br>&#125;<br></code></pre></td></tr></table></figure><p>同时，在该类的定义中我们可以看到在windows中系统根路径被定义为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] WINDOWS_ROOT_PATH = <br>    stringToByteArray(<span class="hljs-string">&quot;Software\\JavaSoft\\Prefs&quot;</span>);<br></code></pre></td></tr></table></figure><p>这也就是为什么解决方法中需要添加这个注册表项了。<br>PS:用户路径为 HKEY_CURRENT_USER\Software\JavaSoft\Prefs</p><p>回过头再来看这个问题，首先配置文件key中出现了 &#x2F; 符号，同时解析配置文件的类用了 PreferencesPlaceholderConfigurer 而不是常规的 PropertyPlaceholderConfigurer 导致Spring同时解析用户和系统环境中的配置，而windows中默认系统根路径注册表中不存在，这才导致了问题的产生。</p><p>按照道理来说这两个注册表项应该是jdk或者jre安装的时候创建的，于是google之，发现了下面的一个issue:<br><a target="_blank" rel="noopener" href="https://bugs.openjdk.java.net/browse/JDK-8139507">https://bugs.openjdk.java.net/browse/JDK-8139507</a><br>里面提到了出现这个问题的原因:<br>jre的一个bug，某个版本之前是正常的，没开启windwos UAC。</p><blockquote class="copyright"><p>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</p></blockquote></main><nav class="pagination"><span class="prev"><a href="/posts/407">TOMCAT 8 COOKIEPROCESSOR 实现变化 </a></span><span class="next"><a href="/posts/342">JAVA 8 DURATION 详解</a></span></nav><script src="/js/main.js"></script><footer><p class="socials"><a href="https://github.com/lostars" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#github"></use></svg> </a><a href="https://open.spotify.com/user/boyizmen" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#spotify"></use></svg> </a><a href="https://space.bilibili.com/20516992" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#bilibili"></use></svg> </a><input type="hidden" id="emailUser" value="bW9tbw=="> <input type="hidden" id="emailDomain" value="bWluZWkubWU="> <a id="emailLink" href="#" target="_blank"><svg class="fontawesome-icon"><use href="/icons/fontawesome.svg#email"></use></svg></a></p><p>Build with ❤ I abandon here my love</p><p>Copyright &copy; 2025 boyizmen</p></footer></body></html>